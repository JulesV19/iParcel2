<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåæ</text></svg>">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>iParcel ‚Äî Twin Agricole Intelligent</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --accent: #10b981;
            --accent-light: #d1fae5;
            --accent-dark: #059669;
            --bg-light: #f8fafc;
            --panel-bg: rgba(255, 255, 255, 0.97);
            --text-main: #0f172a;
            --text-secondary: #334155;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --radius: 20px;
            --radius-sm: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.12);
            --gradient-accent: linear-gradient(135deg, #10b981, #059669);
            --gradient-warm: linear-gradient(135deg, #f59e0b, #ef4444);
            --gradient-cool: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            background: var(--bg-light);
            color: var(--text-main);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        #map {
            position: absolute;
            inset: 0;
            width: 100%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #map.sidebar-open {
            width: calc(100% - 460px);
        }

        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 15;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: none;
            pointer-events: none;
        }

        .top-bar>* {
            pointer-events: auto;
        }

        .site-logo {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--accent-dark);
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--gradient-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .top-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .btn-group {
            display: flex;
            gap: 2px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            padding: 3px;
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-sm);
        }

        .btn-group .top-btn {
            box-shadow: none;
            background: transparent;
            padding: 7px 10px;
            border-radius: 9px;
        }

        .btn-group .top-btn:hover {
            background: var(--border-light);
            box-shadow: none;
            transform: none;
        }

        .btn-group .top-btn.active {
            background: var(--accent);
            color: white;
        }

        .btn-separator {
            width: 1px;
            height: 28px;
            background: var(--border);
            margin: 0 4px;
            flex-shrink: 0;
        }

        .btn-label {
            font-size: 0.75rem;
        }

        .logo-text {
            user-select: none;
        }

        .auth-top-btn {
            gap: 5px;
        }

        .exploitation-btn {
            gap: 5px;
        }

        /* Dark mode */
        body.dark-mode {
            --bg-light: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.97);
            --text-main: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #1e293b;
        }

        body.dark-mode .top-btn {
            background: #1e293b;
            color: #e2e8f0;
        }

        body.dark-mode .btn-group {
            background: rgba(30, 41, 59, 0.9);
        }

        body.dark-mode .btn-group .top-btn {
            background: transparent;
            color: #e2e8f0;
        }

        body.dark-mode .btn-group .top-btn:hover {
            background: #334155;
        }

        body.dark-mode .btn-group .top-btn.active {
            background: var(--accent);
            color: white;
        }

        body.dark-mode .ui-panel {
            background: var(--panel-bg);
            border-color: #334155;
        }

        body.dark-mode #side-panel {
            background: #1e293b;
        }

        body.dark-mode .dashboard-panel {
            background: #1e293b;
        }

        body.dark-mode .info-card {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-mode .tab-bar {
            background: #1e293b;
        }

        body.dark-mode .tab-btn.active {
            background: #334155;
            color: #f1f5f9;
        }

        body.dark-mode select,
        body.dark-mode input {
            background: #1e293b;
            color: #e2e8f0;
            border-color: #334155;
        }

        body.dark-mode .auth-card {
            background: #1e293b;
        }

        body.dark-mode .auth-input {
            background: #0f172a;
            color: #e2e8f0;
            border-color: #334155;
        }

        body.dark-mode .close-btn {
            background: #1e293b;
            color: #94a3b8;
        }

        body.dark-mode .close-btn:hover {
            background: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .side-tab {
            color: #64748b;
        }

        body.dark-mode .side-tab.active {
            color: var(--accent);
        }

        body.dark-mode .coord-display {
            background: rgba(15, 23, 42, 0.8);
            color: #94a3b8;
        }

        body.dark-mode .tool-panel .tool-btn {
            background: #1e293b;
            color: #e2e8f0;
            border-color: #334155;
        }

        body.dark-mode .parcel-list-item {
            border-color: #334155;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   üå≥ GENEALOGY TREE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .tree-viewport {
            padding: 4px 0 14px;
        }

        /* Rang√©e par ann√©e */
        .gtree-row {
            position: relative;
            display: flex;
            align-items: stretch;
            gap: 0;
            min-height: 56px;
        }

        /* Badge ann√©e √† gauche */
        .gtree-year {
            width: 44px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 14px;
            position: relative;
        }

        .gtree-year-label {
            font-size: 0.68rem;
            font-weight: 800;
            color: var(--text-muted);
            z-index: 1;
            background: var(--panel-bg, white);
            padding: 2px 0;
        }

        /* Ligne verticale √† travers les ann√©es */
        .gtree-year::after {
            content: ‚Äú‚Äù;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background: var(--border);
            transform: translateX(-50%);
            z-index: 0;
        }

        .gtree-row:first-child .gtree-year::after {
            top: 14px;
        }

        .gtree-row:last-child .gtree-year::after {
            bottom: 50%;
        }

        /* Zone des noeuds */
        .gtree-nodes {
            flex: 1;
            display: flex;
            gap: 6px;
            padding: 6px 4px;
            position: relative;
            flex-wrap: wrap;
        }

        /* Noeud (une parcelle) */
        .gtree-node {
            flex: 1 1 0;
            min-width: 80px;
            max-width: 220px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .gtree-node:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            border-color: rgba(16, 185, 129, 0.4);
        }

        .gtree-node.is-current {
            border: 2px solid var(--accent);
            box-shadow: 0 0 0 3px rgba(204, 216, 212, 0.15);
        }

        .gtree-node.is-main {
            border-left: 5px solid var(--accent);
        }

        .gtree-node.is-sibling {
            border-left: 4px solid #94a3b8;
            opacity: 0.85;
        }

        /* Accent couleur groupe */
        .gtree-accent {
            height: 4px;
            width: 100%;
        }

        /* Contenu du noeud */
        .gtree-body {
            padding: 7px 9px 8px;
        }

        .gtree-crop {
            font-size: 0.78rem;
            font-weight: 800;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gtree-id {
            font-size: 0.62rem;
            color: var(--text-muted);
            margin-top: 2px;
            font-variant-numeric: tabular-nums;
        }

        .gtree-pct {
            font-size: 0.60rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .gtree-badge {
            display: inline-block;
            font-size: 0.58rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            padding: 1px 6px;
            border-radius: 4px;
            margin-top: 4px;
        }

        /* Connecteurs (lignes entre rang√©es) */
        .gtree-connectors {
            position: relative;
            height: 16px;
            margin-left: 44px;
        }

        .gtree-connectors svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        /* Tag de lien entre rang√©es */
        .gtree-link-tag {
            position: absolute;
            left: 50%;
            top: -2px;
            transform: translateX(-50%);
            font-size: 0.55rem;
            font-weight: 800;
            color: var(--text-muted);
            background: var(--panel-bg, white);
            padding: 0 4px;
            white-space: nowrap;
        }

        /* Dark mode */
        body.dark-mode .gtree-node {
            background: #0f172a;
            border-color: #334155;
        }

        body.dark-mode .gtree-node.is-current {
            border-color: var(--accent);
        }

        body.dark-mode .gtree-year-label,
        body.dark-mode .gtree-link-tag {
            background: var(--panel-bg, #0f172a);
        }

        body.dark-mode .gtree-year::after {
            background: #334155;
        }

        body.dark-mode .parcel-list-item:hover {
            background: #334155;
        }

        body.dark-mode .dash-stat {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-mode .rotation-score-card {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-mode .select-mode-banner {
            background: #312e81;
        }

        body.dark-mode .site-logo {
            color: #10b981;
            text-shadow: none;
        }

        body.dark-mode #btn-darkmode {
            background: #fbbf24;
            color: #0f172a;
        }

        @media (max-width: 900px) {
            .btn-label {
                display: none;
            }

            .btn-separator {
                display: none;
            }

            .top-actions {
                gap: 3px;
            }

            .btn-group {
                padding: 2px;
                gap: 1px;
            }

            .btn-group .top-btn {
                padding: 6px 8px;
            }

            .dashboard-panel {
                width: 100%;
            }
        }

        .top-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            background: white;
            color: var(--text-main);
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .top-btn:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .top-btn.active {
            background: var(--accent);
            color: white;
        }

        .ui-panel {
            position: absolute;
            top: 72px;
            left: 20px;
            z-index: 10;
            width: 370px;
            background: var(--panel-bg);
            padding: 0;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            max-height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: var(--transition);
        }

        .ui-panel.collapsed {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
        }

        .panel-header {
            padding: 20px 22px 0;
            flex-shrink: 0;
        }

        .panel-body {
            padding: 0 22px 22px;
            overflow-y: auto;
            flex: 1;
        }

        .tab-bar {
            display: flex;
            gap: 4px;
            background: var(--border-light);
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 18px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
        }

        .tab-btn.active {
            background: white;
            color: var(--text-main);
            box-shadow: var(--shadow-sm);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .heatmap-viz-legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: var(--border-light);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .h-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.72rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .h-swatch {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        /* Adaptation sp√©cifique pour le mode sombre */
        body.dark-mode .heatmap-viz-legend {
            background: #1e293b;
            border-color: #334155;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        label {
            display: block;
            font-size: .7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin: 16px 0 6px;
        }

        .input-group {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: var(--text-muted);
            pointer-events: none;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 11px 14px 11px 38px;
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--border);
            background: #ffffff;
            color: var(--text-main);
            outline: none;
            font-size: 0.88rem;
            font-family: inherit;
            transition: var(--transition);
        }

        input[type="text"]:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        select {
            padding-left: 14px;
            appearance: none;
            cursor: pointer;
        }

        .range-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        input[type="range"] {
            flex: 1;
            accent-color: var(--accent);
            -webkit-appearance: none;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
        }

        .opacity-badge {
            font-weight: 700;
            min-width: 42px;
            text-align: center;
            background: var(--accent-light);
            color: var(--accent-dark);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.82rem;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .chip {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: 1.5px solid var(--border);
            background: white;
            color: var(--text-secondary);
            transition: var(--transition);
            font-family: inherit;
        }

        .chip:hover {
            border-color: var(--accent);
        }

        .chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .legend-list {
            max-height: 260px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 8px;
            border-radius: 8px;
            font-size: 0.82rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .legend-item:hover {
            background: var(--border-light);
        }

        .legend-item.dimmed {
            opacity: 0.35;
        }

        .swatch {
            width: 16px;
            height: 16px;
            border-radius: 5px;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.08);
        }

        .legend-count {
            margin-left: auto;
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--border-light);
            padding: 2px 6px;
            border-radius: 6px;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
        }

        .stat-card {
            padding: 14px;
            border-radius: var(--radius-sm);
            background: var(--border-light);
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
            font-weight: 500;
        }

        #side-panel {
            position: fixed;
            right: -460px;
            top: 0;
            width: 460px;
            height: 100%;
            background: #ffffff;
            z-index: 1000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -15px 0 40px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }

        #side-panel.open {
            right: 0;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            left: -52px;
            /* Garde la position pour qu'il soit √† l'ext√©rieur du panneau */
            width: 52px;
            height: 52px;
            border: none;
            border-radius: 14px 0 0 14px;
            cursor: pointer;
            background: #ffffff;
            box-shadow: -6px 0 20px rgba(0, 0, 0, 0.08);
            font-size: 18px;
            color: var(--text-muted);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;

            /* AJOUT ICI : Cacher par d√©faut */
            opacity: 0;
            pointer-events: none;
        }

        /* AJOUT ICI : Afficher seulement quand le panel est ouvert */
        #side-panel.open .close-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .close-btn:hover {
            color: var(--text-main);
            background: #f8fafc;
        }

        .panel-header-right {
            padding: 28px 28px 0;
            flex-shrink: 0;
        }

        .panel-content {
            padding: 0 28px 28px;
            overflow-y: auto;
            flex: 1;
        }

        .parcel-title {
            font-size: 1.3rem;
            font-weight: 800;
            margin: 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .culture-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            color: white;
            background: var(--gradient-accent);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 18px 0;
        }

        .info-card {
            padding: 16px;
            border-radius: var(--radius-sm);
            background: var(--border-light);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .info-card:hover {
            border-color: var(--accent);
        }

        .info-card .ic-icon {
            font-size: 20px;
            margin-bottom: 6px;
        }

        .info-card .ic-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .info-card .ic-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .side-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 20px;
        }

        .side-tab {
            padding: 10px 16px;
            border: none;
            background: none;
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: var(--transition);
            font-family: inherit;
        }

        .side-tab.active {
            color: var(--accent-dark);
        }

        .side-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            border-radius: 1px;
        }

        .side-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .side-tab-content.active {
            display: block;
        }

        /* ‚îÄ‚îÄ Rotation Score Card ‚îÄ‚îÄ */
        .rotation-score-card {
            background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
            border: 1.5px solid #bbf7d0;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 18px;
            position: relative;
            overflow: hidden;
        }

        .rotation-score-card.mono {
            background: linear-gradient(135deg, #fef2f2, #fff1f2);
            border-color: #fecaca;
        }

        .rotation-score-card.moderate {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-color: #fde68a;
        }

        .rotation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .rotation-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ Nouveau style sobre pour les badges ‚îÄ‚îÄ */
        .rotation-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #000 !important;
            /* Texte noir forc√© */
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1.5px solid transparent;
            box-shadow: none;
            /* On retire les ombres */
        }

        /* Couleurs de fond pastelles et bordures subtiles */
        .rotation-badge.good {
            background-color: #dcfce7;
            border-color: #86efac;
        }

        .rotation-badge.moderate {
            background-color: #fef9c3;
            border-color: #fde68a;
        }

        .rotation-badge.risky {
            background-color: #ffedd5;
            border-color: #fed7aa;
        }

        .rotation-badge.bad {
            background-color: #fee2e2;
            border-color: #fecaca;
        }

        /* On nettoie aussi la carte de score pour enlever le fond vert/rouge flashy */
        .rotation-score-card,
        .rotation-score-card.mono,
        .rotation-score-card.moderate {
            background: var(--bg-light) !important;
            border: 1px solid var(--border) !important;
            box-shadow: var(--shadow-sm);
        }

        .rotation-score-ring {
            width: 52px;
            height: 52px;
            position: relative;
            margin: 0 auto 8px;
        }

        .rotation-score-ring svg {
            transform: rotate(-90deg);
        }

        .rotation-score-ring .score-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-main);
        }

        /* ‚îÄ‚îÄ Visual Timeline Strip ‚îÄ‚îÄ */
        .timeline-strip {
            display: flex;
            gap: 3px;
            margin-bottom: 18px;
            border-radius: 8px;
            overflow: hidden;
            height: 38px;
            background: var(--border-light);
            border: 1px solid var(--border);
        }

        .strip-cell {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-width: 0;
        }

        .strip-cell:hover {
            filter: brightness(1.15);
            transform: scaleY(1.08);
        }

        .strip-cell .strip-year {
            font-size: 0.55rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            line-height: 1;
        }

        .strip-cell .strip-code {
            font-size: 0.6rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
            line-height: 1;
            margin-top: 1px;
        }

        .strip-cell.current {
            box-shadow: inset 0 -3px 0 rgba(255, 255, 255, 0.6);
        }

        .strip-cell.empty {
            background: repeating-linear-gradient(45deg, #e2e8f0, #e2e8f0 4px, #f1f5f9 4px, #f1f5f9 8px);
        }

        /* ‚îÄ‚îÄ Detailed Timeline ‚îÄ‚îÄ */
        .timeline {
            position: relative;
            padding-left: 28px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--accent), var(--border));
            border-radius: 1px;
        }

        .history-item {
            margin-bottom: 18px;
            position: relative;
            animation: fadeIn 0.4s ease backwards;
        }

        .history-item:nth-child(1) {
            animation-delay: 0.05s;
        }

        .history-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .history-item:nth-child(3) {
            animation-delay: 0.15s;
        }

        .history-item:nth-child(4) {
            animation-delay: 0.2s;
        }

        .history-item:nth-child(5) {
            animation-delay: 0.25s;
        }

        .history-item:nth-child(6) {
            animation-delay: 0.3s;
        }

        .history-item:nth-child(7) {
            animation-delay: 0.35s;
        }

        .history-item:nth-child(8) {
            animation-delay: 0.4s;
        }

        .history-item:nth-child(9) {
            animation-delay: 0.45s;
        }

        .timeline-dot {
            position: absolute;
            left: -24px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--accent);
        }

        .timeline-dot.past {
            background: var(--border);
            box-shadow: 0 0 0 2px var(--border);
        }

        .timeline-dot.event-split {
            background: #f59e0b;
            box-shadow: 0 0 0 2px #f59e0b;
        }

        .timeline-dot.event-merge {
            background: #8b5cf6;
            box-shadow: 0 0 0 2px #8b5cf6;
        }

        .year-badge {
            font-weight: 800;
            color: var(--accent-dark);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .year-badge.current::after {
            content: 'Actuel';
            font-size: 0.6rem;
            background: var(--accent-light);
            color: var(--accent-dark);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .event-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            color: white;
        }

        .event-tag.split {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .event-tag.merge {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .event-tag.new {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .parent-card {
            background: var(--border-light);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .parent-card:hover {
            border-color: var(--accent);
        }

        .parent-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .culture-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        .confidence-bar {
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--gradient-accent);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .siblings-link {
            font-size: 0.7rem;
            color: var(--accent-dark);
            cursor: pointer;
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .siblings-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .weather-stats {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            font-size: 0.78rem;
            flex-wrap: wrap;
        }

        .stat-pill {
            background: white;
            border: 1px solid var(--border);
            padding: 4px 10px;
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .chart-container {
            margin-top: 10px;
            padding: 16px;
            background: var(--border-light);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        /* FIX: suggestions doit √™tre position:absolute dans son parent position:relative */
        .suggestions {
            background: white;
            border-radius: var(--radius-sm);
            margin-top: 4px;
            border: 1.5px solid var(--border);
            overflow: hidden;
            display: none;
            box-shadow: var(--shadow-md);
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            z-index: 20;
        }

        .suggestions.open {
            display: block;
        }

        .suggestions button {
            width: 100%;
            padding: 11px 14px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: var(--transition);
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suggestions button:hover {
            background: var(--accent-light);
            color: var(--accent-dark);
        }

        .suggestions button:last-child {
            border-bottom: none;
        }

        .suggestions-loading,
        .suggestions-empty,
        .suggestions-error {
            padding: 12px 14px;
            font-size: 0.88rem;
            color: var(--text-muted);
        }

        .suggestions-error {
            color: #b91c1c;
        }

        .sug-icon {
            font-size: 14px;
            color: var(--text-muted);
        }

        .tool-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            display: flex;
            gap: 6px;
            padding: 6px;
            background: var(--panel-bg);
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .tool-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .tool-btn:hover {
            background: var(--border-light);
        }

        .tool-btn.active {
            background: var(--accent);
            color: white;
        }

        .coord-display {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 10;
            background: var(--panel-bg);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
            font-variant-numeric: tabular-nums;
        }

        .shortcuts-hint {
            position: fixed;
            bottom: 8px;
            right: 12px;
            z-index: 5;
            font-size: 0.62rem;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .shortcuts-hint kbd {
            background: rgba(255, 255, 255, 0.15);
            padding: 1px 5px;
            border-radius: 3px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            background: white;
            padding: 14px 20px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid var(--accent);
        }

        .toast.show {
            transform: translateX(0);
        }

        .compare-slider {
            position: absolute;
            top: 72px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            background: var(--panel-bg);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 14px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .compare-slider.active {
            display: flex;
        }

        .compare-slider select {
            width: auto;
            padding: 8px 12px;
            padding-left: 12px;
        }

        .note-input {
            width: 100%;
            padding: 10px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 80px;
            outline: none;
            transition: var(--transition);
        }

        .note-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--gradient-accent);
            color: white;
            font-weight: 700;
            font-size: 0.88rem;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            margin-top: 12px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
        }

        @media print {

            .ui-panel,
            .top-bar,
            .tool-panel,
            .coord-display,
            .close-btn {
                display: none !important;
            }

            #side-panel {
                position: relative !important;
                right: 0 !important;
                width: 100% !important;
                box-shadow: none !important;
            }

            #map {
                display: none !important;
            }
        }

        /* ‚îÄ‚îÄ Parcel Viz Mini-Map ‚îÄ‚îÄ */
        #parcel-viz-svg {
            position: relative;
        }

        #parcel-viz-svg .maplibregl-canvas {
            border-radius: var(--radius-sm);
        }

        #parcel-viz-svg .maplibregl-ctrl-attrib {
            display: none !important;
        }

        .viz-legend-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.72rem;
            color: var(--text-secondary);
            margin-right: 12px;
            margin-bottom: 4px;
        }

        .viz-legend-swatch {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        /* ‚îÄ‚îÄ Auth Modal ‚îÄ‚îÄ */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: min(400px, 90vw);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .auth-card h2 {
            margin: 0 0 8px;
            font-size: 1.3rem;
        }

        .auth-card p {
            margin: 0 0 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .auth-input {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 12px;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .auth-input:focus {
            border-color: var(--accent);
        }

        .auth-btn {
            width: 100%;
            padding: 11px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        .auth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auth-toggle {
            margin-top: 14px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .auth-toggle a {
            color: var(--accent);
            cursor: pointer;
            font-weight: 600;
        }

        .auth-error {
            color: #ef4444;
            font-size: 0.8rem;
            margin-bottom: 10px;
            min-height: 1.2em;
        }

        .auth-skip {
            margin-top: 10px;
            text-align: center;
        }

        .auth-skip a {
            color: var(--text-muted);
            font-size: 0.78rem;
            cursor: pointer;
            text-decoration: underline;
        }

        /* ‚îÄ‚îÄ User bar ‚îÄ‚îÄ */
        .user-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
            border: 1px solid #bbf7d0;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            font-size: 0.78rem;
        }

        .user-bar .user-email {
            font-weight: 600;
            color: var(--text-main);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-bar button {
            font-size: 0.7rem;
            padding: 4px 10px;
        }

        /* ‚îÄ‚îÄ Exploitation select mode ‚îÄ‚îÄ */
        .select-mode-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e40af;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 8px 30px rgba(30, 64, 175, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .select-mode-banner.hidden {
            display: none;
        }

        .select-mode-banner button {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            font-size: 0.78rem;
            cursor: pointer;
        }

        .select-mode-banner .btn-done {
            background: #22c55e;
            color: white;
        }

        .select-mode-banner .btn-cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .first-visit-banner {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            background: var(--panel-bg);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            font-size: 0.88rem;
            color: var(--text-secondary);
        }

        .first-visit-banner.hidden {
            display: none !important;
        }

        /* ‚îÄ‚îÄ Dashboard exploitation ‚îÄ‚îÄ */
        .dashboard-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 420px;
            height: 100%;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 500;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .dashboard-panel.open {
            transform: translateX(0);
        }

        .dashboard-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dashboard-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }

        .dashboard-body {
            padding: 16px;
        }

        .dash-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .dash-stat {
            background: var(--panel-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 14px;
            text-align: center;
        }

        .dash-stat .ds-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent-dark);
        }

        .dash-stat .ds-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .dash-section-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0 0 8px 0;
        }

        .dash-exploitation-map {
            width: 100%;
            height: 220px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            overflow: hidden;
            background: var(--border-light);
            margin-bottom: 4px;
        }

        .dash-map-hint {
            font-size: 0.72rem;
            color: var(--text-muted);
            margin: 0 0 16px 0;
        }

        .parcel-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 6px;
            transition: background 0.15s;
        }

        .parcel-list-item:hover {
            background: #f8fafc;
        }

        .parcel-list-item .pli-color {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .parcel-list-item .pli-info {
            flex: 1;
            min-width: 0;
        }

        .parcel-list-item .pli-name {
            font-weight: 600;
            font-size: 0.82rem;
        }

        .parcel-list-item .pli-name-input {
            width: 100%;
            margin-top: 4px;
            padding: 4px 8px;
            font-size: 0.78rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--panel-bg);
            color: var(--text-main);
        }

        .parcel-list-item .pli-name-input::placeholder {
            color: var(--text-muted);
        }

        .parcel-list-item .pli-meta {
            font-size: 0.68rem;
            color: var(--text-muted);
        }

        .parcel-list-item .pli-remove {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: #fee2e2;
            color: #ef4444;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
            height: 16px;
            margin: 6px 0;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @media (max-width: 768px) {
            .ui-panel {
                width: calc(100% - 40px);
                left: 20px;
            }

            #side-panel {
                width: 90%;
                max-width: 400px;
                right: -90%;
                box-shadow: -8px 0 24px rgba(0, 0, 0, 0.15);
            }

            #side-panel.open {
                right: 0;
            }

            /* Carte reste visible derri√®re l‚Äôoverlay */
            #map.sidebar-open {
                width: 100%;
            }

            .close-btn {
                left: auto;
                right: 12px;
                top: 12px;
                width: 44px;
                height: 44px;
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            }

            .tool-panel {
                bottom: 80px;
            }
        }

        /* ‚îÄ‚îÄ √âcran de chargement ‚îÄ‚îÄ */
        #loader {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #0a1628;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.7s ease, visibility 0.7s ease;
        }

        #loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-error-state {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            color: #f1f5f9;
            text-align: center;
            padding: 20px;
        }

        .loader-error-state.hidden {
            display: none !important;
        }

        .loader-error-state p {
            margin: 0;
            font-size: 1rem;
        }

        #loader.loader-error .loader-grid,
        #loader.loader-error .loader-logo,
        #loader.loader-error .loader-progress-wrap {
            display: none !important;
        }

        .loader-grid {
            position: absolute;
            inset: 0;
            overflow: hidden;
            opacity: 0.07;
        }

        .loader-grid-inner {
            position: absolute;
            inset: -10%;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 3px;
            transform: rotate(-8deg) scale(1.2);
        }

        .loader-cell {
            border-radius: 4px;
            background: #10b981;
            animation: cellPulse 3s ease-in-out infinite;
        }

        .loader-cell:nth-child(3n) {
            animation-delay: 0.3s;
            background: #3b82f6;
        }

        .loader-cell:nth-child(5n) {
            animation-delay: 0.6s;
            background: #f59e0b;
        }

        .loader-cell:nth-child(7n) {
            animation-delay: 0.9s;
            background: #a78bfa;
        }

        .loader-cell:nth-child(11n) {
            animation-delay: 1.2s;
            background: #f87171;
        }

        @keyframes cellPulse {

            0%,
            100% {
                opacity: 0.4;
                transform: scale(0.95);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .loader-logo {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            animation: logoEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) both;
        }

        @keyframes logoEntrance {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .loader-icon-wrap {
            width: 90px;
            height: 90px;
            border-radius: 26px;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 44px;
            position: relative;
            animation: iconGlow 2s ease-in-out infinite;
        }

        .loader-icon-wrap::after {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 34px;
            border: 2px solid rgba(16, 185, 129, 0.3);
            animation: ringExpand 2s ease-in-out infinite;
        }

        @keyframes iconGlow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4), 0 20px 40px rgba(16, 185, 129, 0.3);
            }

            50% {
                box-shadow: 0 0 0 16px rgba(16, 185, 129, 0), 0 20px 40px rgba(16, 185, 129, 0.5);
            }
        }

        @keyframes ringExpand {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }

            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }

        .loader-title {
            font-size: 2.4rem;
            font-weight: 900;
            color: white;
            letter-spacing: -0.5px;
            margin: 0;
        }

        .loader-title span {
            color: #10b981;
        }

        .loader-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-top: -12px;
        }

        .loader-progress-wrap {
            position: relative;
            z-index: 1;
            width: 260px;
            margin-top: 48px;
            animation: logoEntrance 0.8s 0.2s cubic-bezier(0.34, 1.56, 0.64, 1) both;
        }

        .loader-progress-track {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .loader-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.4s ease;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }

        .loader-status {
            margin-top: 12px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 500;
            text-align: center;
            min-height: 1.2em;
            transition: opacity 0.3s ease;
        }

        .loader-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 2px;
        }

        .loader-dots span {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            animation: dotBounce 1.2s ease-in-out infinite;
        }

        .loader-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loader-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dotBounce {

            0%,
            80%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            40% {
                transform: translateY(-5px);
                opacity: 1;
            }
        }

        /* ‚îÄ‚îÄ Side panel loading / erreur ‚îÄ‚îÄ */
        .parcel-loading,
        .parcel-error {
            margin: 8px 0 12px;
            font-size: 0.88rem;
        }

        .parcel-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }

        .parcel-loading.hidden,
        .parcel-error.hidden {
            display: none !important;
        }

        .parcel-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: parcelSpin 0.8s linear infinite;
        }

        @keyframes parcelSpin {
            to {
                transform: rotate(360deg);
            }
        }

        .parcel-error p {
            margin: 0 0 10px;
            color: var(--text-secondary);
        }

        .parcel-error .top-btn {
            padding: 6px 14px;
            font-size: 0.85rem;
        }

        /* ‚îÄ‚îÄ Heatmap Styles ‚îÄ‚îÄ */
        .heatmap-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .heatmap-branch {
            background: var(--border-light);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
        }

        .branch-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        .health-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .heatmap-row {
            display: flex;
            gap: 4px;
            height: 32px;
        }

        .heatmap-cell {
            flex: 1;
            border-radius: 4px;
            position: relative;
            cursor: help;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .heatmap-cell:hover {
            transform: scale(1.15);
            z-index: 5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #dev-popup {
            z-index: 10000;
            /* Doit √™tre au-dessus du loader */
            backdrop-filter: blur(8px);
            transition: opacity 0.4s ease;
        }

        #dev-popup.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="dev-popup" class="auth-overlay">
        <div class="auth-card" style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üöß</div>
            <h2 style="margin-bottom: 10px;">Version Beta</h2>
            <p style="color: var(--text-secondary); line-height: 1.5; font-size: 0.85rem;">
                Bienvenue sur <strong>iParcel</strong>. <br>
                Cette application est actuellement en cours de d√©veloppement.
                Certaines <strong>fonctionnalit√©s</strong> (Heatmap, Historique, Exploitation) sont en phase de test.
                Quelques r√©gions sont d√©j√† disponibles, les donn√©es sur la France enti√®re seront bient√¥t disponibles !
            </p>

            <div style="text-align: left; margin-top: 20px;">
                <label>üìç S√©lectionnez votre r√©gion d'√©tude</label>
                <select id="popup-region-select" style="padding-left: 14px; margin-top: 5px;">
                    <option value="BRETAGNE">üìç Bretagne</option>
                    <option value="NORMANDIE">üçé Normandie</option>
                    <option value="PAYS_DE_LA_LOIRE">üåä Pays de la Loire</option>
                    <option value="CENTRE_VAL_DE_LOIRE">üè∞ Centre-Val de Loire</option>
                    <option value="ILE_DE_FRANCE">üóº √éle-de-France</option>
                    <option value="NOUVELLE_AQUITAINE">üåª Nouvelle-Aquitaine</option>
                </select>
            </div>

            <button class="auth-btn" onclick="closeDevPopup()" style="margin-top: 20px;">
                Acc√©der √† l'application
            </button>
        </div>
    </div>
    <!-- ‚îÄ‚îÄ √âcran de chargement ‚îÄ‚îÄ -->
    <div id="loader">
        <div class="loader-grid">
            <div class="loader-grid-inner">
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
                <div class="loader-cell"></div>
            </div>
        </div>
        <div class="loader-logo">
            <div class="loader-icon-wrap">üåæ</div>
            <p class="loader-title">i<span>Parcel</span></p>
            <p class="loader-subtitle">Twin Agricole Intelligent</p>
        </div>
        <div class="loader-progress-wrap">
            <div class="loader-progress-track">
                <div class="loader-progress-bar" id="loader-bar"></div>
            </div>
            <div class="loader-status" id="loader-status">
                Initialisation<div class="loader-dots"><span></span><span></span><span></span></div>
            </div>
        </div>
        <div id="loader-error" class="loader-error-state hidden">
            <p>√âchec du chargement. V√©rifiez votre connexion.</p>
            <button type="button" class="auth-btn" onclick="location.reload()">R√©essayer</button>
        </div>
    </div>


    <!-- Top Bar -->
    <div class="top-bar">
        <div class="site-logo" onclick="resetView()" style="cursor:pointer;" title="Retour √† la vue initiale">
            <div class="logo-icon">üåæ</div>
            <span class="logo-text">iParcel</span>
        </div>
        <div class="top-actions">
            <!-- Outils carte -->
            <div class="btn-group">
                <button class="top-btn" id="btn-toggle-panel" onclick="toggleLeftPanel()" title="Panneau de contr√¥le"
                    aria-label="Ouvrir ou fermer le panneau de contr√¥le">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <line x1="9" y1="3" x2="9" y2="21" />
                    </svg>
                </button>
                <button class="top-btn" id="btn-measure" onclick="toggleMeasure()" title="Mesurer une distance"
                    aria-label="Mesurer une distance sur la carte">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 12h20M12 2v20M6 8l-4 4 4 4M18 8l4 4-4 4" />
                    </svg>
                </button>
                <button class="top-btn" id="btn-compare" onclick="toggleCompare()" title="Comparer deux ann√©es"
                    aria-label="Comparer deux ann√©es">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="8" height="18" rx="1" />
                        <rect x="14" y="3" width="8" height="18" rx="1" />
                    </svg>
                </button>
                <button class="top-btn" id="btn-screenshot" onclick="takeScreenshot()" title="Capture d'√©cran"
                    aria-label="Prendre une capture d'√©cran">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="5" width="18" height="14" rx="2" />
                        <circle cx="12" cy="12" r="3" />
                        <path d="M8 5V3h8v2" />
                    </svg>
                </button>
                <button class="top-btn" id="btn-basemap" onclick="cycleBasemap()" title="Changer le fond de carte"
                    aria-label="Changer le fond de carte">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path
                            d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                    </svg>
                </button>
            </div>
            <div class="btn-separator"></div>
            <!-- Exploitation -->
            <div class="btn-group">
                <!-- Bouton maison: ouvre le dashboard exploitation -->
                <button class="top-btn exploitation-btn" id="btn-dashboard" onclick="toggleDashboard()"
                    title="Dashboard de l'exploitation" aria-label="Ouvrir le tableau de bord de l'exploitation">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg>
                    <span class="btn-label">Exploitation</span>
                </button>
                <!-- Bouton + : mode ajout de parcelles -->
                <button class="top-btn" id="btn-select-mode" onclick="toggleSelectMode()"
                    title="Ajouter des parcelles √† l'exploitation" aria-label="Ajouter des parcelles √† l'exploitation">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                </button>
            </div>
            <div class="btn-separator"></div>
            <!-- User -->
            <button class="top-btn auth-top-btn" id="btn-auth" onclick="showAuthModal()" title="Se connecter"
                aria-label="Se connecter ou cr√©er un compte">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
                <span class="btn-label" id="auth-label">Connexion</span>
            </button>
            <!-- Dark mode -->
            <button class="top-btn" id="btn-darkmode" onclick="toggleDarkMode()" title="Mode sombre"
                aria-label="Activer ou d√©sactiver le mode sombre">üåô</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-overlay hidden" id="auth-overlay" onclick="if(event.target===this)hideAuthModal()">
        <div class="auth-card">
            <div style="text-align:center;margin-bottom:20px;">
                <div
                    style="width:56px;height:56px;border-radius:16px;background:var(--gradient-accent);display:inline-flex;align-items:center;justify-content:center;font-size:28px;color:white;box-shadow:0 8px 24px rgba(16,185,129,0.3);margin-bottom:12px;">
                    üåæ</div>
                <h2 id="auth-title" style="margin:0 0 4px;font-size:1.3rem;">Connexion √† iParcel</h2>
                <p id="auth-subtitle" style="margin:0;color:var(--text-muted);font-size:0.82rem;">Sauvegardez et g√©rez
                    votre exploitation</p>
            </div>
            <div class="auth-error" id="auth-error"></div>
            <input class="auth-input" id="auth-email" type="email" placeholder="Adresse email" autocomplete="email">
            <input class="auth-input" id="auth-password" type="password" placeholder="Mot de passe (6 car. min)"
                autocomplete="current-password">
            <button class="auth-btn" id="auth-submit" onclick="submitAuth()">Se connecter</button>
            <div class="auth-toggle" id="auth-toggle">
                Pas encore de compte ? <a onclick="switchAuthMode()">Cr√©er un compte</a>
            </div>
            <div class="auth-skip">
                <a onclick="hideAuthModal()">Continuer sans compte ‚Üí</a>
            </div>
        </div>
    </div>

    <!-- Banni√®re premi√®re visite -->
    <div class="first-visit-banner hidden" id="first-visit-banner">
        <span>Choisissez une r√©gion et une ann√©e, puis cliquez sur une parcelle pour voir son historique.</span>
        <button type="button" class="top-btn" style="padding:6px 14px;font-size:0.8rem;"
            onclick="dismissFirstVisit()">Compris</button>
    </div>

    <!-- Select Mode Banner -->
    <div class="select-mode-banner hidden" id="select-banner">
        <div style="width:10px;height:10px;border-radius:50%;background:#22c55e;animation:pulse 1.5s infinite;"></div>
        <span>Mode s√©lection ‚Äî Cliquez sur les parcelles</span>
        <span id="select-count"
            style="background:rgba(255,255,255,0.2);padding:3px 12px;border-radius:8px;font-variant-numeric:tabular-nums;">0
            / 200</span>
        <button class="btn-done" onclick="finishSelectMode()">‚úì Terminer</button>
        <button class="btn-cancel" onclick="toggleSelectMode()">‚úï</button>
    </div>
    <style>
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.3);
            }
        }
    </style>

    <!-- Dashboard Panel -->
    <div class="dashboard-panel" id="dashboard-panel">
        <div class="dashboard-header">
            <h2 style="margin:0;font-size:1.1rem;">üè† Mon exploitation</h2>
            <div style="display:flex;gap:6px;">
                <button class="top-btn" onclick="flyToExploitation()" title="Centrer la carte sur l'exploitation"
                    style="padding:6px 10px;">üìç</button>
                <button class="top-btn" onclick="toggleDashboard()" style="padding:6px 10px;">‚úï</button>
            </div>
        </div>
        <div class="dashboard-body">
            <div id="dash-user-bar"></div>
            <input class="auth-input" id="exploitation-name" placeholder="Nom de l'exploitation"
                style="margin-bottom:14px;font-weight:600;" onchange="renameExploitation(this.value)">
            <div class="dash-stat-grid" id="dash-stats"></div>
            <label class="dash-section-label">üó∫Ô∏è Carte de l'exploitation</label>
            <div id="dash-exploitation-map" class="dash-exploitation-map"></div>
            <p class="dash-map-hint">Cliquez sur une parcelle pour la localiser sur la carte principale.</p>
            <div id="dash-rotation-chart" style="margin-bottom:16px;">
                <canvas id="dash-culture-chart" height="180"></canvas>
            </div>
            <div id="dash-alerts" style="margin-bottom:16px;"></div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                <span style="font-weight:700;font-size:0.85rem;">Parcelles</span>
                <button class="top-btn" onclick="toggleSelectMode()" style="font-size:0.72rem;padding:4px 10px;">+
                    Ajouter</button>
            </div>
            <div id="dash-parcel-list"></div>
        </div>
    </div>

    <!-- Compare Slider -->
    <div class="compare-slider" id="compare-bar">
        <span>Gauche:</span>
        <select id="compare-left">
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
        </select>
        <span>Droite:</span>
        <select id="compare-right">
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
        </select>
        <button class="top-btn active" onclick="applyCompare()">Appliquer</button>
        <button class="top-btn" onclick="toggleCompare()">‚úï</button>
    </div>

    <!-- Left Panel -->
    <div class="ui-panel" id="left-panel">
        <div class="panel-header">
            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab(this, 'tab-search')">üîç Recherche</button>
                <button class="tab-btn" onclick="switchTab(this, 'tab-layers')">üóÇÔ∏è Couches</button>
                <button class="tab-btn" onclick="switchTab(this, 'tab-stats')">üìä Stats</button>
            </div>
        </div>
        <div class="panel-body">
            <!-- Tab Recherche -->
            <div class="tab-content active" id="tab-search">
                <label>üìç Localisation</label>
                <!-- FIX: position:relative sur le wrapper pour que les suggestions se positionnent correctement -->
                <div class="input-group" style="position:relative;">
                    <span class="input-icon">üîé</span>
                    <input type="text" id="address-input" placeholder="Chercher une commune, adresse..."
                        autocomplete="off">
                    <div id="suggestions" class="suggestions"></div>
                </div>
                <label>üåç R√©gion d'√©tude</label>
                <select id="region-select">
                    <option value="ALL">üåü TOUTES LES R√âGIONS</option>
                    <option value="BRETAGNE" selected>üìç Bretagne</option>
                    <option value="NORMANDIE">üçé Normandie</option>
                    <option value="PAYS_DE_LA_LOIRE">üåä Pays de la Loire</option>
                    <option value="CENTRE_VAL_DE_LOIRE">üè∞ Centre-Val de Loire</option>
                    <option value="ILE_DE_FRANCE">üóº √éle-de-France</option>
                    <option value="NOUVELLE_AQUITAINE">üåª Nouvelle-Aquitaine</option>
                </select>
                <label>üìÖ Ann√©e de Campagne</label>
                <select id="year-select">
                    <option value="2023">üå± 2023 ‚Äî Campagne actuelle</option>
                    <option value="2022">üåø 2022</option>
                    <option value="2021">üåø 2021</option>
                    <option value="2020">üåø 2020</option>
                    <option value="2019">üåø 2019</option>
                    <option value="2018">üåø 2018</option>
                    <option value="2017">üåø 2017</option>
                    <option value="2016">üåø 2016</option>
                </select>

                <label>üîÜ Transparence des parcelles</label>
                <div class="range-wrap">
                    <input type="range" id="opacity-slider" min="0" max="100" value="70">
                    <div class="opacity-badge"><span id="opacity-value">70</span>%</div>
                </div>

                <label>üè∑Ô∏è Filtrer par groupe</label>
                <div class="filter-chips" id="filter-chips"></div>
            </div>

            <!-- Tab Couches -->
            <div class="tab-content" id="tab-layers">
                <label>üó∫Ô∏è Fond de carte</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px;">
                    <button class="chip active" onclick="setBasemap('satellite', this)">üõ∞Ô∏è Satellite</button>
                    <button class="chip" onclick="setBasemap('streets', this)">üó∫Ô∏è Rues</button>
                    <button class="chip" onclick="setBasemap('terrain', this)">‚õ∞Ô∏è Terrain</button>
                    <button class="chip" onclick="setBasemap('dark', this)">üåô Sombre</button>
                </div>

                <label>üìê Contours des parcelles</label>
                <div class="range-wrap">
                    <input type="range" id="outline-slider" min="0" max="4" value="1" step="0.5">
                    <div class="opacity-badge"><span id="outline-value">1</span>px</div>
                </div>

                <label>üé® L√©gende des cultures</label>
                <div id="legend-list" class="legend-list"></div>
            </div>

            <!-- Tab Stats -->
            <div class="tab-content" id="tab-stats">
                <label>üìä Statistiques de la vue</label>
                <div class="quick-stats" id="quick-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-parcels">‚Äî</div>
                        <div class="stat-label">Parcelles visibles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-surface">‚Äî</div>
                        <div class="stat-label">Surface totale (ha)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-cultures">‚Äî</div>
                        <div class="stat-label">Types de cultures</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-zoom">‚Äî</div>
                        <div class="stat-label">Niveau de zoom</div>
                    </div>
                </div>
                <div class="chart-container" style="margin-top:16px;">
                    <canvas id="stats-chart" height="200"></canvas>
                </div>
                <button class="export-btn" onclick="exportCSV()">üì• Exporter les donn√©es visibles (CSV)</button>
                <div id="lineage-global-stats"></div>
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div id="side-panel" role="region" aria-label="D√©tails de la parcelle">
        <button class="close-btn" onclick="toggleSidebar(false)" aria-label="Fermer le panneau">‚úï</button>
        <div class="panel-header-right">
            <h2 id="parcel-name" class="parcel-title" aria-live="polite">Analyse parcellaire</h2>
            <div id="parcel-loading" class="parcel-loading hidden"><span class="parcel-spinner"></span> Chargement des
                donn√©es‚Ä¶</div>
            <div id="parcel-error" class="parcel-error hidden">
                <p id="parcel-error-msg"></p><button type="button" class="top-btn" id="parcel-retry-btn"
                    onclick="retryParcelDetails()">R√©essayer</button>
            </div>
        </div>
        <div class="panel-content">
            <div class="side-tabs">
                <button class="side-tab active" onclick="switchSideTab(this, 'stab-info')">‚ÑπÔ∏è Infos</button>
                <button class="side-tab" onclick="switchSideTab(this, 'stab-history')">üìú Historique</button>
                <button class="side-tab" onclick="switchSideTab(this, 'stab-parcelle')">üó∫Ô∏è Parcelle</button>
                <button class="side-tab" onclick="switchSideTab(this, 'stab-heatmap')">üìä Heatmap</button>
                <button class="side-tab" onclick="switchSideTab(this, 'stab-tree')">üå≥ Arbre</button>
            </div>

            <div class="side-tab-content active" id="stab-info">
                <div class="info-grid" id="info-grid"></div>
                <label>üå°Ô∏è Conditions m√©t√©o (saison)</label>
                <div class="chart-container">
                    <canvas id="weather-chart" height="180"></canvas>
                </div>
            </div>
            <div class="side-tab-content" id="stab-heatmap">
                <label>üó∫Ô∏è Carte de vigueur de rotation</label>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px;">
                    Cette carte divise votre parcelle en zones selon la qualit√© de l'historique cultural de chaque
                    fragment.
                </div>

                <div id="spatial-heatmap-container"
                    style="height: 300px; border-radius: var(--radius-sm); border: 1px solid var(--border); overflow: hidden; position: relative; background: #f8fafc;">
                </div>
                <div id="spatial-heatmap-legend" class="heatmap-viz-legend" style="grid-template-columns: 1fr;">
                    <div class="h-legend-item"><span class="h-swatch" style="background: #065f46;"></span><span>√âlite
                            (Score 9-10) - Rotation longue & vari√©e</span></div>
                    <div class="h-legend-item"><span class="h-swatch" style="background: #10b981;"></span><span>Optimale
                            (Score 7-8) - Bonne alternance de familles</span></div>
                    <div class="h-legend-item"><span class="h-swatch" style="background: #f59e0b;"></span><span>Moyenne
                            (Score 4-6) - Cycles courts (ex: Bl√©/Ma√Øs)</span></div>
                    <div class="h-legend-item"><span class="h-swatch" style="background: #ef4444;"></span><span>Pauvre
                            (Score 2-3) - Retours fr√©quents</span></div>
                    <div class="h-legend-item"><span class="h-swatch" style="background: #991b1b;"></span><span>Critique
                            (Score 0-1) - Monoculture prolong√©e</span></div>
                </div>

                <div class="info-grid" style="margin-top: 15px; grid-template-columns: 1fr;">
                    <div class="info-card" id="heatmap-status-card" style="border-left: 4px solid var(--accent);">
                        <div class="ic-label" id="heatmap-score-label">Analyse en cours...</div>
                        <div class="ic-value" id="heatmap-score-value">‚Äî</div>
                    </div>
                </div>
            </div>

            <div class="side-tab-content" id="stab-history">
                <div id="rotation-score"></div>
                <div id="timeline-strip-container"></div>
                <div id="siblings-container"></div>
                <div class="timeline" id="history-list"></div>
            </div>

            <div class="side-tab-content" id="stab-parcelle">
                <div id="parcel-viz-controls">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                        <span id="parcel-viz-year"
                            style="font-size:1.4rem;font-weight:900;color:var(--accent-dark);">2023</span>
                        <div style="display:flex;gap:6px;">
                            <button class="top-btn" onclick="parcelVizPrev()" style="padding:6px 10px;">‚óÄ</button>
                            <button class="top-btn" onclick="parcelVizPlay()" id="parcel-viz-play-btn"
                                style="padding:6px 10px;">‚ñ∂ Animer</button>
                            <button class="top-btn" onclick="parcelVizNext()" style="padding:6px 10px;">‚ñ∂</button>
                        </div>
                    </div>
                    <input type="range" id="parcel-viz-slider" min="0" max="7" value="7"
                        style="width:100%;accent-color:var(--accent);">
                    <div id="parcel-viz-year-labels"
                        style="display:flex;justify-content:space-between;font-size:0.65rem;color:var(--text-muted);margin-top:2px;">
                    </div>
                </div>
                <div id="parcel-viz-svg"
                    style="margin-top:14px;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;position:relative;height:320px;">
                </div>
                <div id="parcel-viz-legend" style="margin-top:10px;"></div>
                <div id="parcel-viz-info" style="margin-top:8px;font-size:0.78rem;color:var(--text-secondary);"></div>
            </div>

            <div class="side-tab-content" id="stab-tree">
                <label>üå≥ G√©n√©alogie de la parcelle</label>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px;">
                    Visualisation des fusions et divisions successives.
                </p>
                <div id="genealogy-tree-container" class="tree-viewport">
                </div>
            </div>

            <button class="export-btn" onclick="exportParcelPDF()" style="margin-top:20px;">
                üñ®Ô∏è Exporter le rapport (PDF)
            </button>
        </div>
    </div>

    <!-- Bottom Tool Bar -->
    <div class="tool-panel">
        <button class="tool-btn" onclick="map.zoomIn()" title="Zoom +">Ôºã</button>
        <button class="tool-btn" onclick="map.zoomOut()" title="Zoom ‚àí">‚àí</button>
        <div style="width:1px;height:20px;background:var(--border);margin:0 2px;"></div>
        <button class="tool-btn" id="btn-locate" onclick="geolocate()" title="Ma position">üìç</button>
        <button class="tool-btn" onclick="resetView()" title="Vue initiale">üè†</button>
        <button class="tool-btn" onclick="map.setBearing(0); map.setPitch(0);" title="Orienter au nord">üß≠</button>
        <button class="tool-btn" id="btn-3d" onclick="toggle3D()" title="Vue 3D">3D</button>
    </div>

    <!-- Coordinates -->
    <div class="coord-display" id="coord-display">48.3700¬∞ N, 3.2900¬∞ E ‚Äî Zoom 12</div>

    <!-- Keyboard shortcuts hint -->
    <div id="shortcuts-hint" class="shortcuts-hint" role="status" aria-label="Raccourcis clavier">
        <kbd>D</kbd> sombre <kbd>P</kbd> panneau <kbd>E</kbd> exploitation <kbd>Esc</kbd> fermer
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <div id="map"></div>

    <script>
        // ‚îÄ‚îÄ Globals ‚îÄ‚îÄ
        const years = ["2023", "2022", "2021", "2020", "2019", "2018", "2017", "2016"];
        const cropLabels = {};
        const groupLabels = new Map();
        let lineageData = null;
        let lineageStats = null;
        let parentIndex = null;
        let bucketCache = {};  // Cache des buckets d√©j√† charg√©s: { "44": {parcelles, filiations}, ... }     // Reverse index: parentId+year -> [childIds]
        let compareMode = false;
        let measureMode = false;
        let measurePoints = [];
        let measureMarkers = [];
        let is3D = false;
        let currentParcelId = null;
        let lastDetailParams = null; // pour R√©essayer apr√®s erreur
        let statsChart = null;
        let weatherChart = null;
        let activeFilters = new Set();
        let basemapIndex = 0;
        // FIX: flag pour s'assurer qu'on n'agit sur la carte qu'apr√®s map.on('load')
        let mapReady = false;

        const cultureColors = {
            "1": "#facc15", "2": "#fb923c", "3": "#4ade80", "4": "#f87171",
            "5": "#a3e635", "6": "#fbbf24", "7": "#60a5fa", "8": "#c084fc",
            "9": "#2dd4bf", "10": "#f472b6", "11": "#a78bfa", "12": "#34d399",
            "13": "#fca5a5", "14": "#7dd3fc", "15": "#d8b4fe", "16": "#bef264",
            "17": "#fdba74", "18": "#fb7185", "19": "#67e8f9", "20": "#86efac",
            "21": "#fde68a", "22": "#c4b5fd", "23": "#a5f3fc", "24": "#fecaca",
            "25": "#bbf7d0", "26": "#ddd6fe", "27": "#fed7aa", "28": "#fecdd3",
            "default": "#94a3b8"
        };

        const basemaps = [
            { name: "Satellite", tiles: "https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}" },
            { name: "Rues", tiles: "https://tile.openstreetmap.org/{z}/{x}/{y}.png" },
            { name: "Terrain", tiles: "https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}" },
            { name: "Sombre", tiles: "https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png" }
        ];


        // ‚îÄ‚îÄ Loader progress steps ‚îÄ‚îÄ
        function loaderStep(pct, msg) {
            const bar = document.getElementById('loader-bar');
            const status = document.getElementById('loader-status');
            if (bar) bar.style.width = pct + '%';
            if (status) status.innerHTML = msg + '<div class="loader-dots"><span></span><span></span><span></span></div>';
        }
        function hideLoader() {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.classList.add('hidden');
                setTimeout(() => loader.remove(), 800);
            }
        }
        function showLoaderError() {
            const loader = document.getElementById('loader');
            const errEl = document.getElementById('loader-error');
            if (loader && errEl) {
                loader.classList.add('loader-error');
                errEl.classList.remove('hidden');
            }
        }
        loaderStep(10, 'Chargement de la carte');

        // --- 1. CONFIGURATION DU PROTOCOLE PMTILES ---
        // Cette partie DOIT √™tre au tout d√©but, avant de cr√©er la carte.
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile.bind(protocol));

        // --- 2. INITIALISATION DE LA CARTE ---
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    "basemap": { type: "raster", tiles: [basemaps[0].tiles], tileSize: 256 }
                },
                layers: [{ id: "basemap-layer", type: "raster", source: "basemap" }]
            },
            center: [2.35, 48.85],
            zoom: 12,
            attributionControl: false
        });
        map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
        loaderStep(30, 'Connexion aux tuiles');
        map.addControl(new maplibregl.ScaleControl({ maxWidth: 200 }), 'bottom-left');

        map.on('load', () => {
            loaderStep(60, 'Chargement des parcelles');
            mapReady = true;
            const year = document.getElementById('year-select').value;
            const region = document.getElementById('region-select').value;

            try {
                if (region === 'ALL') {
                    [...document.getElementById('region-select').options]
                        .map(o => o.value).filter(v => v !== 'ALL')
                        .forEach(r => ensureLayer(year, r));
                } else {
                    ensureLayer(year, region);
                }
            } catch (e) { console.warn('ensureLayer:', e); }

            loaderStep(80, 'Chargement des donn√©es');
            init().then(() => {
                loaderStep(95, 'Finalisation');
                updateStats();
            });

            // Masquer le loader d√®s que la carte est idle (tuiles rendues) OU apr√®s 6s max
            const loaderTimeout = setTimeout(hideLoader, 6000);
            map.once('idle', () => {
                clearTimeout(loaderTimeout);
                setTimeout(hideLoader, 300);
            });
        });

        map.on('error', () => showLoaderError());
        // S√©curit√© : apr√®s 10s si le loader est encore visible, proposer R√©essayer
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if (loader && !loader.classList.contains('hidden') && !loader.classList.contains('loader-error')) {
                showLoaderError();
            }
        }, 10000);

        // FIX: mise √† jour des coordonn√©es en temps r√©el
        map.on('mousemove', (e) => {
            const { lng, lat } = e.lngLat;
            const zoom = map.getZoom().toFixed(1);
            const latStr = lat >= 0 ? `${lat.toFixed(4)}¬∞ N` : `${Math.abs(lat).toFixed(4)}¬∞ S`;
            const lngStr = lng >= 0 ? `${lng.toFixed(4)}¬∞ E` : `${Math.abs(lng).toFixed(4)}¬∞ W`;
            document.getElementById('coord-display').textContent = `${latStr}, ${lngStr} ‚Äî Zoom ${zoom}`;
        });

        // FIX: mise √† jour des stats au changement de vue
        map.on('moveend', updateStats);
        map.on('zoomend', () => {
            document.getElementById('stat-zoom').textContent = map.getZoom().toFixed(1);
            updateStats();
        });

        // FIX: clic sur les parcelles ‚Äî g√©r√© apr√®s que les couches soient pr√™tes
        map.on('click', (e) => {
            if (measureMode) {
                addMeasurePoint(e.lngLat);
                return;
            }

            const year = document.getElementById('year-select').value;

            // On r√©cup√®re TOUTES les couches de l'ann√©e s√©lectionn√©e qui commencent par "lyr-"
            const activeLayers = map.getStyle().layers
                .filter(l => l.id.startsWith('lyr-') && l.id.includes(`_${year}`) && !l.id.includes('outline'))
                .map(l => l.id);

            if (activeLayers.length === 0) return;

            // On cherche la parcelle parmi toutes ces couches
            const features = map.queryRenderedFeatures(e.point, { layers: activeLayers });
            if (!features.length) return;

            // ... reste de ton code (feature, props, parcelId) ...

            const feature = features[0];
            const props = feature.properties;

            const parcelId = String(
                feature.id
                ?? props.ID_PARCEL
                ?? props.id_parcel
                ?? props.ID
                ?? props.id
                ?? props.NUMERO
                ?? props.numero
                ?? props.FID
                ?? `${props.CODE_CULTU}_${e.lngLat.lat.toFixed(5)}_${e.lngLat.lng.toFixed(5)}`
            );
            console.log('[iParcel] parcelId r√©solu =', parcelId, '| dans lineage ?', !!(lineageData && lineageData[parcelId]));

            // ‚îÄ‚îÄ Select mode: add parcel to exploitation ‚îÄ‚îÄ
            if (selectMode) {
                if (!currentUser || !currentExploitation) {
                    showToast('Connectez-vous d\'abord', '‚ö†Ô∏è');
                    showAuthModal();
                    return;
                }
                console.log('[Exploitation] Ajout parcelle:', parcelId);
                // Flash visuel sur la parcelle cliqu√©e
                highlightFeature(feature);
                addParcelToExploitation(parcelId, props, e.lngLat);
                return;
            }

            // Extraire la r√©gion depuis le layer ID (ex: "lyr-NORMANDIE_2023" ‚Üí "NORMANDIE")
            const layerId = feature.layer && feature.layer.id || '';
            const featureRegion = layerId.startsWith('lyr-') ? layerId.slice(4).replace(/_\d{4}$/, '') : null;

            highlightFeature(feature);
            showDetails(e, parcelId, props, featureRegion);
        });

        map.on('mousemove', (e) => {
            const year = document.getElementById('year-select').value;
            const activeLayers = map.getStyle().layers
                .filter(l => l.id.startsWith('lyr-') && l.id.includes(`_${year}`) && !l.id.includes('outline'))
                .map(l => l.id);

            const features = map.queryRenderedFeatures(e.point, { layers: activeLayers });
            map.getCanvas().style.cursor = (features.length > 0) ? 'pointer' : (measureMode ? 'crosshair' : '');
        });

        // ‚îÄ‚îÄ Toast (dur√©e 2s confirmations, 4s erreurs) ‚îÄ‚îÄ
        function showToast(msg, icon = "‚úÖ", durationMs) {
            const t = document.getElementById('toast');
            t.innerHTML = `<span>${icon}</span> ${msg}`;
            t.classList.add('show');
            const duration = durationMs != null ? durationMs : (icon === '‚ùå' || icon === '‚ö†Ô∏è' ? 4000 : 2000);
            setTimeout(() => t.classList.remove('show'), duration);
        }

        // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
        function switchTab(btn, tabId) {
            btn.closest('.tab-bar').querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            btn.closest('.ui-panel').querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        function switchSideTab(btn, tabId) {
            btn.closest('.side-tabs').querySelectorAll('.side-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.side-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        // ‚îÄ‚îÄ Left Panel Toggle ‚îÄ‚îÄ
        function toggleLeftPanel() {
            const p = document.getElementById('left-panel');
            p.classList.toggle('collapsed');
            document.getElementById('btn-toggle-panel').classList.toggle('active');
        }

        // ‚îÄ‚îÄ Basemap ‚îÄ‚îÄ
        // FIX: fonction utilitaire pour remplacer le fond de carte en toute s√©curit√©
        function swapBasemap(idx) {
            if (!mapReady) return;
            const bm = basemaps[idx];
            try {
                if (map.getLayer('basemap-layer')) map.removeLayer('basemap-layer');
                if (map.getSource('basemap')) map.removeSource('basemap');
            } catch (e) { }
            map.addSource('basemap', { type: 'raster', tiles: [bm.tiles], tileSize: 256 });
            const layers = map.getStyle().layers;
            const firstOther = layers.find(l => l.id !== 'basemap-layer');
            map.addLayer({ id: 'basemap-layer', type: 'raster', source: 'basemap' },
                firstOther ? firstOther.id : undefined);
        }

        function setBasemap(name, btn) {
            const idx = basemaps.findIndex(b => b.name.toLowerCase().includes(name.toLowerCase()));
            if (idx < 0) return;
            basemapIndex = idx;
            swapBasemap(idx);
            if (btn) {
                btn.closest('div').querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
            }
            showToast(`Fond de carte: ${basemaps[idx].name}`, "üó∫Ô∏è");
        }

        function cycleBasemap() {
            basemapIndex = (basemapIndex + 1) % basemaps.length;
            swapBasemap(basemapIndex);
            showToast(`Fond: ${basemaps[basemapIndex].name}`, "üó∫Ô∏è");
        }

        // ‚îÄ‚îÄ 3D Toggle ‚îÄ‚îÄ
        function toggle3D() {
            is3D = !is3D;
            map.easeTo({ pitch: is3D ? 60 : 0, duration: 500 });
            document.getElementById('btn-3d').classList.toggle('active', is3D);
            showToast(is3D ? "Vue 3D activ√©e" : "Vue 2D", "üèîÔ∏è");
        }

        // ‚îÄ‚îÄ Geolocation ‚îÄ‚îÄ
        function geolocate() {
            if (!navigator.geolocation) return showToast("G√©olocalisation non disponible", "‚ö†Ô∏è");
            navigator.geolocation.getCurrentPosition(pos => {
                map.flyTo({ center: [pos.coords.longitude, pos.coords.latitude], zoom: 14 });
                new maplibregl.Marker({ color: '#3b82f6' })
                    .setLngLat([pos.coords.longitude, pos.coords.latitude])
                    .addTo(map);
                showToast("Position trouv√©e", "üìç");
            }, () => showToast("Position refus√©e", "‚ö†Ô∏è"));
        }

        function resetView() {
            map.flyTo({ center: [-3.29, 48.37], zoom: 12, pitch: 0, bearing: 0 });
        }

        // ‚îÄ‚îÄ Measure Tool ‚îÄ‚îÄ
        function toggleMeasure() {
            measureMode = !measureMode;
            document.getElementById('btn-measure').classList.toggle('active', measureMode);
            if (!measureMode) {
                clearMeasure();
                showToast("Mesure d√©sactiv√©e", "üìè");
            } else {
                showToast("Cliquez sur la carte pour mesurer", "üìè");
            }
            map.getCanvas().style.cursor = measureMode ? 'crosshair' : '';
        }

        function clearMeasure() {
            measurePoints = [];
            measureMarkers.forEach(m => m.remove());
            measureMarkers = [];
            try {
                if (map.getLayer('measure-line-layer')) map.removeLayer('measure-line-layer');
                if (map.getSource('measure-line')) map.removeSource('measure-line');
            } catch (e) { }
        }

        function addMeasurePoint(lngLat) {
            measurePoints.push([lngLat.lng, lngLat.lat]);
            const el = document.createElement('div');
            el.style.cssText = 'width:10px;height:10px;background:#3b82f6;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3)';
            const m = new maplibregl.Marker({ element: el }).setLngLat(lngLat).addTo(map);
            measureMarkers.push(m);

            if (measurePoints.length > 1) {
                const geojson = { type: 'Feature', geometry: { type: 'LineString', coordinates: measurePoints } };
                if (map.getSource('measure-line')) {
                    map.getSource('measure-line').setData(geojson);
                } else {
                    map.addSource('measure-line', { type: 'geojson', data: geojson });
                    map.addLayer({
                        id: 'measure-line-layer', type: 'line', source: 'measure-line',
                        paint: { 'line-color': '#3b82f6', 'line-width': 3, 'line-dasharray': [2, 2] }
                    });
                }
                showToast(`Distance: ${calcTotalDistance(measurePoints)}`, "üìè");
            }
        }

        function calcTotalDistance(pts) {
            let total = 0;
            for (let i = 1; i < pts.length; i++) {
                total += haversine(pts[i - 1][1], pts[i - 1][0], pts[i][1], pts[i][0]);
            }
            return total < 1 ? `${Math.round(total * 1000)} m` : `${total.toFixed(2)} km`;
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // ‚îÄ‚îÄ Compare Mode ‚îÄ‚îÄ
        function toggleCompare() {
            compareMode = !compareMode;
            document.getElementById('compare-bar').classList.toggle('active', compareMode);
            document.getElementById('btn-compare').classList.toggle('active', compareMode);
            if (!compareMode) {
                const selected = document.getElementById('year-select').value;
                const op = document.getElementById('opacity-slider').value / 100;
                years.forEach(y => {
                    const lyr = `lyr-${y}`;
                    if (map.getLayer(lyr)) {
                        map.setPaintProperty(lyr, 'fill-opacity', y === selected ? op : 0);
                    }
                });
            }
        }

        function applyCompare() {
            if (!mapReady) return;
            const left = document.getElementById('compare-left').value;
            const right = document.getElementById('compare-right').value;
            ensureLayer(left);
            ensureLayer(right);
            const op = document.getElementById('opacity-slider').value / 100;
            years.forEach(y => {
                const lyr = `lyr-${y}`;
                if (map.getLayer(lyr)) {
                    if (y === left) map.setPaintProperty(lyr, 'fill-opacity', op);
                    else if (y === right) map.setPaintProperty(lyr, 'fill-opacity', op * 0.5);
                    else map.setPaintProperty(lyr, 'fill-opacity', 0);
                }
            });
            showToast(`Comparaison ${left} vs ${right}`, "üîÑ");
        }

        // ‚îÄ‚îÄ Screenshot ‚îÄ‚îÄ
        function takeScreenshot() {
            map.once('render', () => {
                const canvas = map.getCanvas();
                canvas.toBlob(blob => {
                    if (!blob) { showToast("√âchec de la capture", "‚ö†Ô∏è"); return; }
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `iparcel-capture-${new Date().toISOString().slice(0, 10)}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast("Capture t√©l√©charg√©e", "üì∏");
                });
            });
            map.triggerRepaint();
        }

        // ‚îÄ‚îÄ Data Init ‚îÄ‚îÄ
        async function init() {
            // Chargement du CSV : fetch en ArrayBuffer + d√©codage Windows-1252 via TextDecoder
            // (PapaParse avec encoding:"windows-1252" ne d√©code pas correctement les accents dans tous les navigateurs)
            try {
                const csvResponse = await fetch("REF_CULTURES_GROUPES_CULTURES_2023.csv");
                if (csvResponse.ok) {
                    const buffer = await csvResponse.arrayBuffer();
                    const text = new TextDecoder("windows-1252").decode(buffer);
                    const res = Papa.parse(text, { header: true, delimiter: ";" });
                    res.data.forEach(row => {
                        if (row.CODE_CULTURE) cropLabels[row.CODE_CULTURE.trim()] = row.LIBELLE_CULTURE;
                        if (row.CODE_GROUPE_CULTURE) groupLabels.set(row.CODE_GROUPE_CULTURE.trim(), row.LIBELLE_GROUPE_CULTURE);
                    });
                }
            } catch (e) {
                console.log("CSV de r√©f√©rence non trouv√©.");
            }
            renderLegend();
            renderFilterChips();
            updateMapColors();

        }

        // ‚îÄ‚îÄ Legend ‚îÄ‚îÄ
        function renderLegend() {
            const box = document.getElementById("legend-list");
            if (groupLabels.size === 0) {
                box.innerHTML = '<div style="color:var(--text-muted);font-size:0.8rem;padding:8px;">Chargez un fichier CSV de r√©f√©rence pour afficher la l√©gende.</div>';
                return;
            }
            let html = "";
            groupLabels.forEach((lib, code) => {
                const color = cultureColors[code] || cultureColors.default;
                html += `<div class="legend-item" onclick="toggleLegendFilter('${code}', this)" data-code="${code}">
            <div class="swatch" style="background:${color}"></div>
            <span>${lib}</span>
        </div>`;
            });
            box.innerHTML = html;
        }

        function renderFilterChips() {
            const box = document.getElementById("filter-chips");
            let html = '<button class="chip active" onclick="clearFilters(this)">Toutes</button>';
            groupLabels.forEach((lib, code) => {
                html += `<button class="chip" onclick="toggleChipFilter('${code}', this)">${lib}</button>`;
            });
            box.innerHTML = html;
        }

        function toggleLegendFilter(code, el) {
            el.classList.toggle('dimmed');
            if (activeFilters.has(code)) activeFilters.delete(code);
            else activeFilters.add(code);
            applyFilter();
        }

        function toggleChipFilter(code, btn) {
            btn.classList.toggle('active');
            if (activeFilters.has(code)) activeFilters.delete(code);
            else activeFilters.add(code);
            applyFilter();
        }

        function clearFilters(btn) {
            activeFilters.clear();
            document.querySelectorAll('#filter-chips .chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.legend-item').forEach(l => l.classList.remove('dimmed'));
            applyFilter();
        }

        function applyFilter() {
            const year = document.getElementById('year-select').value;
            const filter = activeFilters.size === 0 ? null : ['in', ['get', 'CODE_GROUP'], ['literal', [...activeFilters]]];

            // On applique le filtre sur TOUTES les couches de l'ann√©e en cours
            map.getStyle().layers.forEach(lyr => {
                if (lyr.id.startsWith('lyr-') && lyr.id.includes(`_${year}`)) {
                    map.setFilter(lyr.id, filter);
                }
            });
        }

        // ‚îÄ‚îÄ Map Colors ‚îÄ‚îÄ
        function getMapColorExpression() {
            const expression = ["match", ["get", "CODE_GROUP"]];
            for (const [code, color] of Object.entries(cultureColors)) {
                if (code !== "default") expression.push(code, color);
            }
            expression.push(cultureColors.default);
            return expression;
        }

        function updateMapColors() {
            years.forEach(y => {
                const lyrId = `lyr-${y}`;
                if (map.getLayer(lyrId)) {
                    map.setPaintProperty(lyrId, "fill-color", getMapColorExpression());
                }
            });
        }

        function ensureLayer(year, specificRegion = null) {
            if (!mapReady) return;

            // Si on passe une r√©gion (mode ALL), on l'utilise. 
            // Sinon, on prend la valeur actuelle du s√©lecteur.
            const region = specificRegion || document.getElementById('region-select').value;

            // S√©curit√© : ne rien faire si on est sur "ALL" sans r√©gion sp√©cifi√©e
            if (region === "ALL" && !specificRegion) return;

            const fileName = `${region}_${year}`; // Ex: NORMANDIE_2023
            const srcId = `src-${fileName}`;
            const lyrId = `lyr-${fileName}`;

            if (!map.getSource(srcId)) {
                map.addSource(srcId, {
                    type: "vector",
                    url: `pmtiles://https://huggingface.co/datasets/Juckles19/iparcel-public/resolve/main/${fileName}.pmtiles`
                });
            }
            if (!map.getLayer(lyrId)) {
                map.addLayer({
                    id: lyrId, type: "fill", source: srcId, "source-layer": "parcelles",
                    paint: {
                        "fill-color": getMapColorExpression(),
                        "fill-opacity": (year === document.getElementById('year-select').value) ? (document.getElementById('opacity-slider').value / 100) : 0,
                        "fill-outline-color": "rgba(255,255,255,0.6)"
                    }
                });
                map.addLayer({
                    id: `${lyrId}-outline`, type: "line", source: srcId, "source-layer": "parcelles",
                    paint: {
                        "line-color": "rgba(255,255,255,0.8)",
                        "line-width": parseFloat(document.getElementById('outline-slider').value)
                    }
                });
            }
        }

        // ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ
        let highlightedFeature = null;

        function clearHighlight() {
            if (!mapReady) return;
            try {
                if (map.getSource('highlight-src')) {
                    map.getSource('highlight-src').setData({ type: 'FeatureCollection', features: [] });
                }
            } catch (e) { }
            highlightedFeature = null;
        }

        function highlightFeature(feature) {
            if (!mapReady) return;
            // Create highlight source+layers if they don't exist yet
            if (!map.getSource('highlight-src')) {
                map.addSource('highlight-src', {
                    type: 'geojson',
                    data: { type: 'FeatureCollection', features: [] }
                });
                map.addLayer({
                    id: 'highlight-fill', type: 'fill', source: 'highlight-src',
                    paint: {
                        'fill-color': '#facc15',
                        'fill-opacity': 0.35
                    }
                });
                map.addLayer({
                    id: 'highlight-outline', type: 'line', source: 'highlight-src',
                    paint: {
                        'line-color': '#facc15',
                        'line-width': 3,
                        'line-opacity': 1
                    }
                });
            }
            // Set the clicked feature as highlight data
            map.getSource('highlight-src').setData({
                type: 'FeatureCollection',
                features: [{ type: 'Feature', geometry: feature.geometry, properties: {} }]
            });
            highlightedFeature = feature;
        }

        function toggleSidebar(open) {
            document.getElementById('side-panel').classList.toggle('open', open);
            document.getElementById('map').classList.toggle('sidebar-open', open);
            if (open) document.getElementById('dashboard-panel').classList.remove('open');
            if (!open) { clearHighlight(); destroyMiniMap(); }
            setTimeout(() => map.resize(), 400);
        }

        // ‚îÄ‚îÄ Stats Panel ‚îÄ‚îÄ
        // FIX: fonction manquante ajout√©e
        function updateStats() {
            if (!mapReady) return;
            const year = document.getElementById('year-select').value;
            document.getElementById('stat-zoom').textContent = map.getZoom().toFixed(1);

            // Trouver tous les layers fill visibles pour l'ann√©e s√©lectionn√©e
            const visibleLayers = map.getStyle().layers
                .filter(lyr => lyr.id.startsWith('lyr-') && lyr.id.includes(`_${year}`) && lyr.type === 'fill')
                .map(lyr => lyr.id);

            if (visibleLayers.length === 0) {
                document.getElementById('stat-parcels').textContent = '‚Äî';
                document.getElementById('stat-surface').textContent = '‚Äî';
                document.getElementById('stat-cultures').textContent = '‚Äî';
                return;
            }

            const features = map.queryRenderedFeatures({ layers: visibleLayers });
            document.getElementById('stat-parcels').textContent = features.length.toLocaleString('fr-FR');

            const surface = features.reduce((sum, f) => sum + parseFloat(f.properties.SURF_PARC || 0), 0);
            document.getElementById('stat-surface').textContent = surface.toFixed(1);

            const cultures = new Set(features.map(f => f.properties.CODE_CULTU).filter(Boolean));
            document.getElementById('stat-cultures').textContent = cultures.size;

            renderStatsChart(features);
        }

        function renderStatsChart(features) {
            const ctx = document.getElementById('stats-chart').getContext('2d');
            if (statsChart) statsChart.destroy();

            // Agr√©ger par groupe de culture
            const groups = {};
            features.forEach(f => {
                const code = f.properties.CODE_GROUP || 'Inconnu';
                const label = groupLabels.get(code) || `Groupe ${code}`;
                if (!groups[label]) groups[label] = 0;
                groups[label] += parseFloat(f.properties.SURF_PARC || 0);
            });

            // Trier par surface d√©croissante, garder top 8
            const sorted = Object.entries(groups).sort((a, b) => b[1] - a[1]).slice(0, 8);
            const labels = sorted.map(([k]) => k);
            const data = sorted.map(([, v]) => parseFloat(v.toFixed(1)));
            const bgColors = Object.keys(cultureColors)
                .filter(k => k !== 'default')
                .slice(0, sorted.length)
                .map(k => cultureColors[k]);

            statsChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: bgColors, borderWidth: 2, borderColor: '#fff' }] },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, padding: 8, usePointStyle: true } },
                        tooltip: { callbacks: { label: (ctx) => ` ${ctx.label}: ${ctx.parsed.toFixed(1)} ha` } }
                    }
                }
            });
        }

        // ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
        // FIX: fonction manquante ajout√©e
        function exportCSV() {
            const year = document.getElementById('year-select').value;
            const lyrId = `lyr-${year}`;
            if (!map.getLayer(lyrId)) { showToast("Aucune couche active", "‚ö†Ô∏è"); return; }

            const features = map.queryRenderedFeatures({ layers: [lyrId] });
            if (!features.length) { showToast("Aucune parcelle visible", "‚ö†Ô∏è"); return; }

            const keys = ['ID_PARCEL', 'CODE_CULTU', 'CODE_GROUP', 'SURF_PARC'];
            const rows = [keys.join(';')];
            const seen = new Set();

            features.forEach(f => {
                const id = f.properties.ID_PARCEL || f.id || '';
                if (seen.has(id)) return;
                seen.add(id);
                rows.push(keys.map(k => f.properties[k] ?? '').join(';'));
            });

            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `iparcel-export-${year}-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`${rows.length - 1} parcelles export√©es`, "üì•");
        }

        // ‚îÄ‚îÄ Notes ‚îÄ‚îÄ
        // FIX: fonctions manquantes ajout√©es ‚Äî stockage localStorage
        function saveNote() {
            if (!currentParcelId) { showToast("Aucune parcelle s√©lectionn√©e", "‚ö†Ô∏è"); return; }
            const text = document.getElementById('parcel-note').value.trim();
            if (!text) { showToast("Note vide", "‚ö†Ô∏è"); return; }

            const key = `note_${currentParcelId}`;
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            existing.unshift({ text, date: new Date().toLocaleString('fr-FR') });
            localStorage.setItem(key, JSON.stringify(existing));

            document.getElementById('parcel-note').value = '';
            loadNotes(currentParcelId);
            showToast("Note sauvegard√©e", "üíæ");
        }

        function loadNotes(parcelId) {
            const key = `note_${parcelId}`;
            const notes = JSON.parse(localStorage.getItem(key) || '[]');
            const box = document.getElementById('saved-notes');
            if (!notes.length) {
                box.innerHTML = '<span style="color:var(--text-muted);">Aucune note.</span>';
                return;
            }
            box.innerHTML = notes.map(n => `
        <div style="background:var(--border-light);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;margin-bottom:8px;">
            <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:4px;">${n.date}</div>
            <div style="color:var(--text-main);">${n.text.replace(/\n/g, '<br>')}</div>
        </div>
    `).join('');
        }

        // ‚îÄ‚îÄ Export PDF ‚îÄ‚îÄ
        // FIX: fonction manquante ‚Äî impression via window.print()
        function exportParcelPDF() {
            if (!currentParcelId) { showToast("Aucune parcelle s√©lectionn√©e", "‚ö†Ô∏è"); return; }
            showToast("Ouverture impression‚Ä¶", "üñ®Ô∏è");
            setTimeout(() => window.print(), 500);
        }

        function dismissFirstVisit() {
            try { localStorage.setItem('iparcel_visited', '1'); } catch (e) { }
            document.getElementById('first-visit-banner').classList.add('hidden');
        }

        // ‚îÄ‚îÄ Address Search (BAN API) avec debounce, chargement et erreur ‚îÄ‚îÄ
        let searchTimeout;
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('iparcel_visited')) {
                document.getElementById('first-visit-banner').classList.remove('hidden');
            }

            const input = document.getElementById('address-input');
            const sugBox = document.getElementById('suggestions');

            input.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const q = input.value.trim();
                if (q.length < 3) { sugBox.classList.remove('open'); return; }
                sugBox.innerHTML = '<div class="suggestions-loading">Recherche‚Ä¶</div>';
                sugBox.classList.add('open');
                searchTimeout = setTimeout(async () => {
                    try {
                        const r = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&limit=5`);
                        const data = await r.json();
                        if (data.features && data.features.length) {
                            sugBox.innerHTML = data.features.map(f => {
                                const label = f.properties.label.replace(/'/g, "\\'");
                                const [lng, lat] = f.geometry.coordinates;
                                return `<button type="button" onclick="flyToResult(${lng}, ${lat}, '${label}')">
                            <span class="sug-icon">üìç</span> ${f.properties.label}
                        </button>`;
                            }).join('');
                            sugBox.classList.add('open');
                        } else {
                            sugBox.innerHTML = '<div class="suggestions-empty">Aucun r√©sultat</div>';
                            sugBox.classList.add('open');
                        }
                    } catch (e) {
                        sugBox.innerHTML = '<div class="suggestions-error">Recherche indisponible. R√©essayez plus tard.</div>';
                        sugBox.classList.add('open');
                    }
                }, 300);
            });

            input.addEventListener('blur', () => setTimeout(() => sugBox.classList.remove('open'), 200));

            // FIX: event listener pour le slider d'opacit√©
            document.getElementById('opacity-slider').addEventListener('input', function () {
                const val = this.value;
                document.getElementById('opacity-value').textContent = val;
                if (!mapReady) return;

                const year = document.getElementById('year-select').value;
                const op = val / 100;

                // On applique l'opacit√© √† TOUTES les r√©gions de l'ann√©e s√©lectionn√©e
                map.getStyle().layers.forEach(lyr => {
                    if (lyr.id.startsWith('lyr-') && lyr.id.includes(`_${year}`) && lyr.type === 'fill') {
                        map.setPaintProperty(lyr.id, 'fill-opacity', op);
                    }
                });
            });

            // FIX: event listener pour le slider de contour
            document.getElementById('outline-slider').addEventListener('input', function () {
                const val = parseFloat(this.value);
                document.getElementById('outline-value').textContent = val;
                if (!mapReady) return;

                const year = document.getElementById('year-select').value;

                // On applique l'√©paisseur √† TOUTES les couches "line" de l'ann√©e s√©lectionn√©e
                map.getStyle().layers.forEach(lyr => {
                    if (lyr.id.startsWith('lyr-') && lyr.id.includes(`_${year}`) && lyr.type === 'line') {
                        map.setPaintProperty(lyr.id, 'line-width', val);
                    }
                });
            });

            // FIX: event listener pour le changement d'ann√©e
            document.getElementById('year-select').addEventListener('change', function () {
                if (!mapReady) return;
                const year = this.value;
                const op = document.getElementById('opacity-slider').value / 100;
                const region = document.getElementById('region-select').value;

                // Charger les layers n√©cessaires pour la nouvelle ann√©e
                if (region === 'ALL') {
                    [...document.getElementById('region-select').options]
                        .map(o => o.value).filter(v => v !== 'ALL')
                        .forEach(r => ensureLayer(year, r));
                } else {
                    ensureLayer(year, region);
                }

                // Masquer toutes les couches sauf l'ann√©e s√©lectionn√©e
                // Les layers sont nomm√©es lyr-{REGION}_{year}, pas lyr-{year}
                map.getStyle().layers.forEach(lyr => {
                    if (lyr.id.startsWith('lyr-') && lyr.id !== 'highlight-fill') {
                        const isSelected = lyr.id.includes(`_${year}`);
                        // En mode r√©gion unique, ne montrer que la bonne r√©gion
                        const isCorrectRegion = region === 'ALL' || lyr.id.includes(region);
                        const visible = isSelected && isCorrectRegion;
                        if (lyr.type === 'fill') {
                            map.setPaintProperty(lyr.id, 'fill-opacity', visible ? op : 0);
                        } else if (lyr.type === 'line' && lyr.id.endsWith('-outline')) {
                            map.setPaintProperty(lyr.id, 'line-opacity', visible ? 1 : 0);
                        }
                    }
                });
                applyFilter();
                updateStats();
                showToast(`Ann√©e ${year} charg√©e`, "üìÖ");
            });
        });
        // √Ä ajouter vers la ligne 1050
        document.getElementById('region-select').addEventListener('change', function () {
            const year = document.getElementById('year-select').value;
            const region = this.value;
            const op = document.getElementById('opacity-slider').value / 100;

            // Liste de TOUTES les r√©gions disponibles sur ton Hugging Face
            // Construire la liste depuis les options du select (toujours synchronis√©)
            const allRegions = [...document.getElementById('region-select').options]
                .map(o => o.value).filter(v => v !== 'ALL');

            if (region === "ALL") {
                // 1. On lance le chargement de chaque r√©gion pour l'ann√©e choisie
                allRegions.forEach(r => ensureLayer(year, r));

                // 2. On rend visible toutes les couches de cette ann√©e
                map.getStyle().layers.forEach(lyr => {
                    if (lyr.id.startsWith('lyr-')) {
                        const isCorrectYear = lyr.id.includes(`_${year}`);
                        map.setPaintProperty(lyr.id, lyr.type === 'fill' ? 'fill-opacity' : 'line-opacity', isCorrectYear ? (lyr.type === 'fill' ? op : 1) : 0);
                    }
                });
                showToast("Affichage de toutes les r√©gions", "üåü");
            } else {
                // Mode r√©gion unique classique
                ensureLayer(year, region);
                const activeLyrId = `lyr-${region}_${year}`;
                map.getStyle().layers.forEach(lyr => {
                    if (lyr.id.startsWith('lyr-')) {
                        const isTarget = lyr.id.startsWith(activeLyrId);
                        map.setPaintProperty(lyr.id, lyr.type === 'fill' ? 'fill-opacity' : 'line-opacity', isTarget ? (lyr.type === 'fill' ? op : 1) : 0);
                    }
                });
                showToast(`R√©gion ${region} activ√©e`, "üåç");
            }
            updateStats();
        });
        function flyToResult(lng, lat, label) {
            map.flyTo({ center: [lng, lat], zoom: 13 });
            document.getElementById('address-input').value = label;
            document.getElementById('suggestions').classList.remove('open');
            showToast(`Navigation vers ${label}`, "üìç");
        }

        // ‚îÄ‚îÄ Weather Fetch ‚îÄ‚îÄ
        async function fetchWeather(lat, lng, year) {
            try {
                const r = await fetch(
                    `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lng}` +
                    `&start_date=${year}-03-01&end_date=${year}-10-31` +
                    `&daily=temperature_2m_mean,precipitation_sum&timezone=Europe%2FParis`
                );
                const d = await r.json();
                if (!d.daily) return null;
                const temps = d.daily.temperature_2m_mean.filter(v => v !== null);
                if (!temps.length) return null;
                const avgT = temps.reduce((a, b) => a + b, 0) / temps.length;
                const sumR = d.daily.precipitation_sum.reduce((a, b) => a + (b || 0), 0);
                return {
                    temp: avgT.toFixed(1),
                    rain: Math.round(sumR),
                    maxT: Math.max(...temps).toFixed(1),
                    minT: Math.min(...temps).toFixed(1),
                    dailyTemps: d.daily.temperature_2m_mean,
                    dailyRain: d.daily.precipitation_sum,
                    dates: d.daily.time
                };
            } catch (e) { return null; }
        }

        // ‚îÄ‚îÄ Bucket loader with cache (region-aware) + retry et structure d'erreur ‚îÄ‚îÄ
        async function loadBucket(bucketId, explicitRegion, retries = 2) {
            const effectiveRegion = explicitRegion || document.getElementById('region-select').value;
            if (effectiveRegion === "ALL") {
                console.warn('[iParcel] loadBucket appel√© sans r√©gion explicite en mode ALL');
                return { error: true, message: 'R√©gion non pr√©cis√©e', status: 0 };
            }
            const cacheKey = `${effectiveRegion}_${bucketId}`;

            if (bucketCache[cacheKey]) return bucketCache[cacheKey];

            const url = `https://huggingface.co/datasets/Juckles19/iparcel-public/resolve/main/${effectiveRegion}_${bucketId}.json`;
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        bucketCache[cacheKey] = data;
                        return data;
                    }
                    if (attempt === retries) {
                        return { error: true, status: response.status, message: response.status === 404 ? 'Donn√©es introuvables pour cette zone' : `Erreur ${response.status}` };
                    }
                } catch (e) {
                    if (attempt === retries) {
                        return { error: true, status: 0, message: 'Connexion impossible. V√©rifiez votre r√©seau.' };
                    }
                }
            }
            return { error: true, status: 0, message: 'Chargement √©chou√©' };
        }

        function retryParcelDetails() {
            if (!lastDetailParams) return;
            showDetails(lastDetailParams.e, lastDetailParams.parcelId, lastDetailParams.props, lastDetailParams.parcelRegion);
        }

        // ‚îÄ‚îÄ Parcel Details ‚Äî single fetch, pre-calculated lineage ‚îÄ‚îÄ
        async function showDetails(e, parcelId, props, parcelRegion) {
            const year = document.getElementById('year-select').value;
            const compositeId = `${year}_${parcelId}`;
            currentParcelId = parcelId;
            lastDetailParams = { e, parcelId, props, parcelRegion };

            console.log(`[iParcel] Recherche : ${compositeId}`);

            document.getElementById('parcel-name').innerHTML = "Chargement‚Ä¶";
            document.getElementById('parcel-loading').classList.remove('hidden');
            document.getElementById('parcel-error').classList.add('hidden');
            toggleSidebar(true);

            try {
                // Bucket = 2 derniers chiffres du compositeId (= de parcelId)
                const bucket = compositeId.slice(-2);
                const data = await loadBucket(bucket, parcelRegion);

                if (data && data.error) {
                    document.getElementById('parcel-name').innerHTML = "Erreur";
                    document.getElementById('parcel-error-msg').textContent = data.message || "Impossible de charger les donn√©es.";
                    document.getElementById('parcel-loading').classList.add('hidden');
                    document.getElementById('parcel-error').classList.remove('hidden');
                    showToast(data.message || "Chargement impossible", "‚ùå");
                    return;
                }

                const parcelInfo = data && data.parcelles ? data.parcelles[compositeId] : null;

                // Build full lineage by walking parent chain within the bucket
                let record = null;
                if (parcelInfo) {
                    const lineage = {};
                    let currentUid = compositeId;
                    const visited = new Set([currentUid]);

                    for (let depth = 0; depth < 15; depth++) {
                        const fil = data.filiations && data.filiations[currentUid];
                        if (!fil || !fil.parents || fil.parents.length === 0) break;

                        // Best parent (highest overlap)
                        const best = fil.parents.reduce((a, b) => b.pct > a.pct ? b : a);
                        const parentUid = best.uid;
                        if (visited.has(parentUid)) break;
                        visited.add(parentUid);

                        const parentYear = parentUid.split('_')[0];
                        const parentIdParcel = parentUid.split('_').slice(1).join('_');

                        // Look up parent info ‚Äî may be in same bucket or different
                        let parentInfo = data.parcelles ? data.parcelles[parentUid] : null;
                        if (!parentInfo) {
                            // Parent is in a different bucket
                            const parentBucket = parentUid.slice(-2);
                            const parentData = await loadBucket(parentBucket, parcelRegion);
                            if (parentData && parentData.error) break; // arr√™t cha√Æne si erreur r√©seau/404
                            parentInfo = parentData && parentData.parcelles ? parentData.parcelles[parentUid] : null;
                            // Also check filiations in parent bucket for next iteration
                            if (parentData && parentData.filiations && parentData.filiations[parentUid]) {
                                if (!data.filiations) data.filiations = {};
                                data.filiations[parentUid] = parentData.filiations[parentUid];
                            }
                        }

                        lineage[parentYear] = {
                            c: parentInfo ? parentInfo.c : '?',
                            g: parentInfo ? parentInfo.g : '',
                            s: parentInfo ? parentInfo.s : null,
                            cf: best.pct,
                            p: parentIdParcel,
                        };

                        // Find siblings (other children of same parent)
                        // stored later in record.sib

                        currentUid = parentUid;
                    }

                    // Build siblings from filiations (other children of each parent)
                    const siblings = {};
                    for (const [yr, entry] of Object.entries(lineage)) {
                        const parentUid = `${yr}_${entry.p}`;
                        const parentFil = data.filiations && data.filiations[parentUid];
                        if (parentFil && parentFil.children && parentFil.children.length > 1) {
                            const sibs = [];
                            for (const child of parentFil.children) {
                                const childId = child.uid.split('_').slice(1).join('_');
                                if (childId === parcelId) continue;
                                const childInfo = data.parcelles ? data.parcelles[child.uid] : null;
                                sibs.push({
                                    id: childId,
                                    c: childInfo ? childInfo.c : '?',
                                    g: childInfo ? childInfo.g : '',
                                    cf: child.pct,
                                });
                            }
                            if (sibs.length > 0) siblings[yr] = sibs;
                        }
                    }

                    record = {
                        ...parcelInfo,
                        c: parcelInfo.c || props.CODE_CULTU,
                        g: parcelInfo.g || props.CODE_GROUP,
                        c23: parcelInfo.c || props.CODE_CULTU,
                        g23: parcelInfo.g || props.CODE_GROUP,
                        lineage: lineage,
                        l: lineage,
                        sib: siblings,
                    };
                }

                // Store in lineageData
                if (!lineageData) lineageData = {};
                if (record) lineageData[parcelId] = record;

                // Build parentIndex
                if (!parentIndex) parentIndex = {};
                if (record) {
                    const lin = record.lineage || {};
                    for (const [yr, entry] of Object.entries(lin)) {
                        if (entry.p) {
                            const key = `${entry.p}_${yr}`;
                            if (!parentIndex[key]) parentIndex[key] = [];
                            if (!parentIndex[key].includes(parcelId)) parentIndex[key].push(parcelId);
                        }
                    }
                    for (const [yr, sibs] of Object.entries(record.sib || {})) {
                        const parentId = lin[yr]?.p;
                        if (parentId) {
                            const key = `${parentId}_${yr}`;
                            if (!parentIndex[key]) parentIndex[key] = [];
                            for (const sib of sibs) {
                                if (!parentIndex[key].includes(sib.id)) parentIndex[key].push(sib.id);
                                if (!lineageData[sib.id]) lineageData[sib.id] = { c23: sib.c, g23: sib.g };
                            }
                        }
                    }
                }

                // --- Display ---
                const cropName = cropLabels[props.CODE_CULTU] || props.CODE_CULTU || "Culture inconnue";
                const groupName = groupLabels.get(props.CODE_GROUP) || props.CODE_GROUP || "";
                const lineage = record ? (record.lineage || {}) : {};
                const lineageYears = Object.keys(lineage);
                const yearsTracked = lineageYears.length > 0 ? lineageYears.length + 1 : 1;
                const siblings = record ? (record.sib || {}) : {};
                const hasSiblings = Object.keys(siblings).length > 0;

                document.getElementById('parcel-name').innerHTML = `${cropName} <span class="culture-badge">${groupName}</span>`;
                document.getElementById('parcel-loading').classList.add('hidden');
                showToast("Donn√©es charg√©es", "‚úÖ");

                document.getElementById('info-grid').innerHTML = `
            <div class="info-card"><div class="ic-icon">üÜî</div><div class="ic-value" style="font-size:0.7rem;">${parcelId}</div><div class="ic-label">ID Parcelle</div></div>
            <div class="info-card"><div class="ic-icon">üìê</div><div class="ic-value">${props.SURF_PARC ? parseFloat(props.SURF_PARC).toFixed(2) : '‚Äî'} ha</div><div class="ic-label">Surface</div></div>
            <div class="info-card"><div class="ic-icon">üìÖ</div><div class="ic-value">${yearsTracked} an${yearsTracked > 1 ? 's' : ''}</div><div class="ic-label">Historique</div></div>
            <div class="info-card"><div class="ic-icon">üåæ</div><div class="ic-value">${props.CODE_CULTU || '‚Äî'}</div><div class="ic-label">Code culture</div></div>
            ${hasSiblings ? `<div class="info-card"><div class="ic-icon">‚úÇÔ∏è</div><div class="ic-value">${Object.values(siblings).flat().length}</div><div class="ic-label">S≈ìurs</div></div>` : ''}
        `;

                const w = await fetchWeather(e.lngLat.lat, e.lngLat.lng, year);
                if (w) renderWeatherChart(w);

                renderHistoryWithRecord(parcelId, props, record);

                if (highlightedFeature) {
                    renderSpatialHeatmap(parcelId, highlightedFeature, record, parcelRegion);
                    initParcelViz(parcelId, highlightedFeature, props, record, parcelRegion);
                    renderGenealogyTree(parcelId, parcelRegion);
                }

            } catch (err) {
                console.error("[iParcel] Erreur :", err);
                document.getElementById('parcel-name').innerHTML = "Donn√©es indisponibles";
                document.getElementById('parcel-error-msg').textContent = "Une erreur s‚Äôest produite. V√©rifiez votre connexion ou r√©essayez.";
                document.getElementById('parcel-loading').classList.add('hidden');
                document.getElementById('parcel-error').classList.remove('hidden');
                showToast("Impossible de charger les donn√©es", "‚ùå");
            }
        }

        function renderWeatherChart(w) {
            const ctx = document.getElementById('weather-chart').getContext('2d');
            if (weatherChart) weatherChart.destroy();

            const months = {};
            w.dates.forEach((d, i) => {
                const m = d.slice(0, 7);
                if (!months[m]) months[m] = { temps: [], rain: 0 };
                if (w.dailyTemps[i] !== null) months[m].temps.push(w.dailyTemps[i]);
                months[m].rain += (w.dailyRain[i] || 0);
            });

            const labels = Object.keys(months).map(m => {
                const mo = parseInt(m.split('-')[1]);
                return ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'][mo - 1];
            });
            const tempData = Object.values(months).map(m =>
                m.temps.length ? (m.temps.reduce((a, b) => a + b, 0) / m.temps.length).toFixed(1) : null
            );
            const rainData = Object.values(months).map(m => Math.round(m.rain));

            weatherChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Pr√©cipitations (mm)', data: rainData,
                            backgroundColor: 'rgba(59,130,246,0.3)', borderColor: '#3b82f6',
                            borderWidth: 1, borderRadius: 4, yAxisID: 'y1'
                        },
                        {
                            label: 'Temp√©rature (¬∞C)', data: tempData,
                            type: 'line', borderColor: '#ef4444',
                            backgroundColor: 'rgba(239,68,68,0.1)', fill: true,
                            tension: 0.4, pointRadius: 3, pointBackgroundColor: '#ef4444',
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: true, labels: { font: { size: 10 }, usePointStyle: true } } },
                    scales: {
                        y: { position: 'left', title: { display: true, text: '¬∞C', font: { size: 10 } }, grid: { color: '#f1f5f9' } },
                        y1: { position: 'right', title: { display: true, text: 'mm', font: { size: 10 } }, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // ‚îÄ‚îÄ Compute global stats from lineage ‚îÄ‚îÄ
        function computeLineageStats(data) {
            let total = 0, withHistory = 0, monocultures = 0, splits = 0;
            let totalChanges = 0, maxDepth = 0;
            const allCultures = {};

            for (const [pid, rec] of Object.entries(data)) {
                total++;
                const lin = rec.lineage || rec.l;
                if (!lin || Object.keys(lin).length === 0) continue;
                withHistory++;
                const years = Object.keys(lin);
                if (years.length > maxDepth) maxDepth = years.length;

                // Culture tracking
                const currentCode = rec.c23 || rec["culture_2023"] || '';
                const cultures = [currentCode];
                const parentIds = new Set();
                let prev = currentCode;
                for (const y of years.sort((a, b) => b - a)) {
                    const code = lin[y].c || lin[y].culture || '';
                    cultures.push(code);
                    if (code && code !== prev && prev) totalChanges++;
                    prev = code;
                    const p = lin[y].p || lin[y].parent_id;
                    if (p) parentIds.add(p);
                    // Low confidence = probable split
                    const cf = lin[y].cf ?? lin[y].confidence;
                    if (cf !== null && cf !== undefined && cf < 0.5) splits++;
                }
                const uniqueCultures = new Set(cultures.filter(c => c && c !== '‚Äî'));
                if (uniqueCultures.size === 1 && cultures.length > 2) monocultures++;

                cultures.forEach(c => { if (c && c !== '‚Äî') allCultures[c] = (allCultures[c] || 0) + 1; });
            }

            // Top cultures
            const topCultures = Object.entries(allCultures)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            return { total, withHistory, monocultures, splits, totalChanges, maxDepth, topCultures };
        }

        // ‚îÄ‚îÄ Render global lineage stats in Stats tab ‚îÄ‚îÄ
        function renderLineageGlobalStats() {
            const container = document.getElementById('lineage-global-stats');
            if (!container || !lineageStats) { if (container) container.innerHTML = ''; return; }
            const s = lineageStats;

            const topCultHtml = s.topCultures.map(([code, count]) => {
                const name = cropLabels[code] || code;
                return `<span class="stat-pill">${name}: ${count.toLocaleString('fr-FR')}</span>`;
            }).join('');

            container.innerHTML = `
        <label style="margin-top:18px;">üß¨ G√©n√©alogie des parcelles</label>
        <div class="quick-stats" style="grid-template-columns:1fr 1fr;">
            <div class="stat-card">
                <div class="stat-value">${s.withHistory.toLocaleString('fr-FR')}</div>
                <div class="stat-label">Parcelles avec historique</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${s.maxDepth + 1} ans</div>
                <div class="stat-label">Profondeur max</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${s.monocultures.toLocaleString('fr-FR')}</div>
                <div class="stat-label">Monocultures d√©tect√©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${s.splits.toLocaleString('fr-FR')}</div>
                <div class="stat-label">D√©coupes probables</div>
            </div>
        </div>
        <label style="margin-top:12px;">üèÜ Cultures les plus fr√©quentes (historique)</label>
        <div class="weather-stats" style="margin-top:6px;">${topCultHtml}</div>
    `;
        }

        // ‚îÄ‚îÄ Find siblings: parcels sharing the same parent in a given year ‚îÄ‚îÄ
        function findSiblings(parcelId, record) {
            if (!record || !parentIndex) return [];
            const lineage = record.lineage || record.l || {};
            const years = Object.keys(lineage).sort((a, b) => b - a);
            const seen = new Set();
            const siblings = [];

            for (const yr of years) {
                const parentId = lineage[yr].p || lineage[yr].parent_id;
                if (!parentId) continue;
                const key = `${parentId}_${yr}`;
                const sibs = parentIndex[key] || [];
                for (const sibId of sibs) {
                    if (sibId === parcelId || seen.has(sibId)) continue;
                    seen.add(sibId);
                    const sibRec = lineageData[sibId];
                    if (!sibRec) continue;
                    // Get sibling's culture for that year
                    const sibLin = sibRec.lineage || sibRec.l || {};
                    const sibEntry = sibLin[yr];
                    siblings.push({
                        id: sibId,
                        year: yr,
                        parentId: parentId,
                        culture: sibEntry ? (sibEntry.c || sibEntry.culture) : (sibRec.c23 || '?'),
                        confidence: sibEntry ? (sibEntry.cf ?? sibEntry.confidence) : null,
                    });
                }
            }
            return siblings;
        }

        // ‚îÄ‚îÄ Render siblings ‚îÄ‚îÄ
        function renderSiblings(siblings) {
            const container = document.getElementById('siblings-container');
            if (!container) return;
            if (!siblings || siblings.length === 0) {
                container.innerHTML = '';
                return;
            }

            const items = siblings.slice(0, 8).map(s => {
                const cropName = cropLabels[s.culture] || s.culture || '?';
                const conf = s.confidence !== null ? Math.round(s.confidence * 100) : null;
                return `
            <div class="parent-card" style="margin-bottom:6px;cursor:pointer;" 
                 title="Parcelle s≈ìur issue du m√™me parent ${s.parentId} en ${s.year}">
                <div class="parent-card-header">
                    <div class="culture-dot" style="background:${getCultureColorByCulture(s.culture)}"></div>
                    <div style="font-weight:600;color:var(--text-main);font-size:0.82rem;">${cropName}</div>
                    <div style="margin-left:auto;font-size:0.68rem;color:var(--text-muted);">
                        üÜî ${s.id}
                    </div>
                </div>
                <div style="font-size:0.68rem;color:var(--text-muted);margin-top:3px;">
                    Ann√©e ${s.year} ¬∑ Parent: ${s.parentId}${conf !== null ? ` ¬∑ Fiabilit√©: ${conf}%` : ''}
                </div>
            </div>`;
            }).join('');

            container.innerHTML = `
        <div style="background:linear-gradient(135deg,#fefce8,#fef9c3);border:1.5px solid #fde68a;border-radius:var(--radius-sm);padding:14px;margin-bottom:14px;">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;">
                <span style="font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#92400e;">
                    ‚úÇÔ∏è Parcelles s≈ìurs
                </span>
                <span style="font-size:0.65rem;background:#fbbf24;color:white;padding:2px 8px;border-radius:10px;font-weight:700;">
                    ${siblings.length}
                </span>
            </div>
            <div style="font-size:0.72rem;color:#a16207;margin-bottom:8px;">
                Issues du m√™me d√©coupage parcellaire
            </div>
            ${items}
            ${siblings.length > 8 ? `<div style="font-size:0.7rem;color:var(--text-muted);margin-top:6px;">+ ${siblings.length - 8} autres</div>` : ''}
        </div>`;
        }

        // ‚îÄ‚îÄ renderHistory ‚Äî enhanced with siblings, mutation detection, parent navigation ‚îÄ‚îÄ
        function getCultureColor(codeGroup) {
            return cultureColors[codeGroup] || cultureColors.default;
        }

        function computeRotationScore(cultures) {
            const valid = cultures.filter(c => c && c !== '‚Äî' && c !== '');
            if (valid.length < 3) return { score: 0, label: 'Donn√©es insuffisantes', level: 'moderate' };

            const families = {
                '1': 'C√©r√©ale', '2': 'C√©r√©ale', '3': 'Fourrage', '4': 'Ol√©agineux',
                '5': 'C√©r√©ale', '6': 'C√©r√©ale', '9': 'Prot√©agineux', '11': 'Fourrage'
            };

            let penalties = 0;
            let botanicalGroups = new Set();
            let consecutiveCount = 0;
            let lastCulture = null;

            valid.forEach((c) => {
                botanicalGroups.add(families[c] || 'Autre');

                if (c === lastCulture) consecutiveCount++;
                else consecutiveCount = 0;

                // P√©nalit√©s divis√©es par 2 (plus indulgent)
                if (consecutiveCount === 1) penalties += 1;
                if (consecutiveCount > 1) penalties += 2;

                lastCulture = c;
            });

            // Multiplicateur augment√© pour valoriser la diversit√© m√™me faible
            let rawScore = (botanicalGroups.size / valid.length) * 15;
            let finalScore = Math.max(0, Math.min(10, Math.round(rawScore - penalties)));

            let label, level;
            // Seuils abaiss√©s pour √™tre plus encourageant
            if (finalScore >= 7) { label = 'R√©g√©n√©rative'; level = 'good'; }
            else if (finalScore >= 5) { label = 'Diversifi√©e'; level = 'good'; }
            else if (finalScore >= 3) { label = 'Conventionnelle'; level = 'moderate'; }
            else if (finalScore >= 1) { label = 'Risqu√©e (Cycles courts)'; level = 'risky'; }
            else { label = 'Monoculture critique'; level = 'bad'; }

            return { score: finalScore, label, level, unique: botanicalGroups.size, total: valid.length };
        }
        let spatialHeatmapMap = null;

        function renderRotationScore(scoreData) {
            const container = document.getElementById('rotation-score');
            if (!container) return;
            if (!scoreData || scoreData.total < 2) { container.innerHTML = ''; return; }
            const cardClass = scoreData.level === 'good' ? '' : scoreData.level === 'bad' ? ' mono' : ' moderate';
            const pct = Math.min(100, scoreData.score * 10);
            const strokeColor = scoreData.level === 'good' ? '#10b981' : scoreData.level === 'bad' ? '#ef4444' : '#f59e0b';
            const circumference = 2 * Math.PI * 20;
            const offset = circumference - (pct / 100) * circumference;
            container.innerHTML = `
        <div class="rotation-score-card${cardClass}">
            <div class="rotation-header">
                <div>
                    <div class="rotation-label">Diversit√© des cultures</div>
                    <div style="font-size:0.85rem;font-weight:600;color:var(--text-main);margin-top:4px;">
                        ${scoreData.unique} culture${scoreData.unique > 1 ? 's' : ''} diff√©rente${scoreData.unique > 1 ? 's' : ''} sur ${scoreData.total} ans
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;">
                    <div class="rotation-score-ring">
                        <svg width="52" height="52" viewBox="0 0 52 52">
                            <circle cx="26" cy="26" r="20" fill="none" stroke="#e2e8f0" stroke-width="5"/>
                            <circle cx="26" cy="26" r="20" fill="none" stroke="${strokeColor}" stroke-width="5"
                                stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                                stroke-linecap="round" style="transition:stroke-dashoffset 1s ease"/>
                        </svg>
                        <div class="score-text">${scoreData.score}</div>
                    </div>
                    <span class="rotation-badge ${scoreData.level}">${scoreData.label}</span>
                </div>
            </div>
        </div>`;
        }

        function renderTimelineStrip(entries) {
            const container = document.getElementById('timeline-strip-container');
            if (!container) return;
            if (!entries || entries.length < 2) { container.innerHTML = ''; return; }
            const cells = entries.map(e => {
                const bg = e.cultureGroup ? getCultureColor(e.cultureGroup) : '#cbd5e1';
                const cls = e.isCurrent ? ' current' : (e.empty ? ' empty' : '');
                const code = e.cultureCode || '?';
                return `<div class="strip-cell${cls}" style="background:${e.empty ? '' : bg}"
                    title="${e.year}: ${cropLabels[code] || code}${e.confidence != null ? ' (fiabilit√© ' + Math.round(e.confidence * 100) + '%)' : ''}">
                    <span class="strip-year">${String(e.year).slice(2)}</span>
                    <span class="strip-code">${code}</span>
                </div>`;
            }).join('');
            container.innerHTML = `<div class="timeline-strip">${cells}</div>`;
        }

        function renderHistoryWithRecord(parcelId, props, record) {
            const list = document.getElementById('history-list');
            const currentYear = document.getElementById('year-select').value;

            if (!record) {
                renderRotationScore(null);
                renderTimelineStrip(null);
                list.innerHTML = `<p style="padding:15px;color:var(--text-muted);">Aucun historique pour cette parcelle.</p>`;
                return;
            }

            const lineage = record.lineage || record.l || {};
            const sortedYears = Object.keys(lineage).sort((a, b) => b - a);
            const isFirstYearOnly = sortedYears.length === 0;

            const allEntries = [{
                year: parseInt(currentYear),
                cultureCode: record.c || record.c23 || props.CODE_CULTU,
                cultureGroup: record.g || record.g23 || props.CODE_GROUP,
                isCurrent: true
            }];
            const allCultures = [record.c || record.c23 || props.CODE_CULTU];

            sortedYears.forEach(y => {
                const entry = lineage[y];
                const code = entry.c || '‚Äî';
                allEntries.push({
                    year: parseInt(y), cultureCode: code,
                    cultureGroup: entry.g || '', confidence: entry.cf, isCurrent: false
                });
                allCultures.push(code);
            });

            renderRotationScore(computeRotationScore(allCultures));
            renderTimelineStrip(allEntries.sort((a, b) => a.year - b.year));

            const currentCropName = cropLabels[record.c || record.c23 || props.CODE_CULTU] || record.c || props.CODE_CULTU;
            let html = isFirstYearOnly ? `<p style="padding:0 0 12px;font-size:0.85rem;color:var(--text-muted);">Premi√®re ann√©e de suivi pour cette parcelle.</p>` : '';
            html += `
        <div class="history-item">
            <div class="timeline-dot"></div>
            <div class="year-badge current">${currentYear}</div>
            <div class="parent-card">
                <div class="parent-card-header">
                    <div class="culture-dot" style="background:${getCultureColor(record.g || record.g23 || props.CODE_GROUP)}"></div>
                    <div style="font-weight:600;color:var(--text-main);">${currentCropName}</div>
                </div>
                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">${props.SURF_PARC ? parseFloat(props.SURF_PARC).toFixed(2) + ' ha' : '‚Äî'}</div>
            </div>
        </div>`;

            let prevCulture = record.c || record.c23 || props.CODE_CULTU;

            html += sortedYears.map(y => {
                const entry = lineage[y];
                const code = entry.c || '‚Äî';
                const cropName = cropLabels[code] || code;
                const confidence = entry.cf != null ? Math.round(entry.cf * 100) : null;
                const parentId = entry.p || null;
                const surface = entry.s ? parseFloat(entry.s).toFixed(2) + ' ha' : '';
                const groupColor = entry.g ? getCultureColor(entry.g) : getCultureColor('');
                const cultureChanged = code !== prevCulture && code !== '‚Äî' && prevCulture !== '‚Äî';
                prevCulture = code;

                // Siblings count for this year
                const sibs = (record.sib && record.sib[y]) || [];

                return `
            <div class="history-item">
                <div class="timeline-dot past ${confidence !== null && confidence < 50 ? 'event-split' : ''}"></div>
                <div class="year-badge">
                    ${y}
                    ${confidence !== null && confidence < 50 ? '<span class="event-tag split">‚úÇÔ∏è D√©coupe</span>' : ''}
                    ${cultureChanged ? '<span class="event-tag new">üîÑ Changement</span>' : ''}
                    ${sibs.length > 0 ? '<span class="event-tag split">‚úÇÔ∏è ' + sibs.length + ' s≈ìur' + (sibs.length > 1 ? 's' : '') + '</span>' : ''}
                </div>
                <div class="parent-card">
                    <div class="parent-card-header">
                        <div class="culture-dot" style="background:${groupColor}"></div>
                        <div style="font-weight:600;color:var(--text-main);">${cropName}</div>
                    </div>
                    ${surface ? `<div style="font-size:0.72rem;color:var(--text-muted);margin-top:2px;">üìê ${surface}</div>` : ''}
                    ${confidence !== null ? `
                        <div class="confidence-bar"><div class="confidence-fill" style="width:${confidence}%"></div></div>
                        <span style="font-size:0.7rem;color:var(--text-muted);">Fiabilit√©: ${confidence}%</span>
                    ` : ''}
                    ${parentId ? `<br><span style="font-size:0.65rem;color:var(--text-muted);cursor:pointer;" onclick="loadParent('${y}_${parentId}')">üîó Parent: ${parentId}</span>` : ''}
                </div>
            </div>`;
            }).join('');

            list.innerHTML = html;
        }

        function scoreToColor(s) {
            if (s >= 7) return "#10b981";  // Vert ‚Äî bon
            if (s >= 4) return "#f59e0b";  // Orange ‚Äî moyen
            if (s >= 2) return "#fbbf24";  // Jaune ‚Äî risqu√©
            return "#ef4444";              // Rouge ‚Äî mauvais
        }

        async function buildParentLineage(parentUid, parcelRegion, maxDepth = 6) {
            // Remonte la cha√Æne de filiation d'un parent pour r√©cup√©rer son historique de cultures
            const cultures = [];
            let uid = parentUid;
            const visited = new Set();

            for (let d = 0; d < maxDepth; d++) {
                if (visited.has(uid)) break;
                visited.add(uid);

                const bucket = uid.slice(-2);
                const bData = await loadBucket(bucket, parcelRegion);
                if (!bData || bData.error) break;

                // R√©cup√©rer la culture de ce parent
                const info = bData.parcelles ? bData.parcelles[uid] : null;
                if (info && info.c && info.c !== '?') cultures.push(info.c);

                // Remonter au meilleur parent
                const fil = bData.filiations ? bData.filiations[uid] : null;
                if (!fil || !fil.parents || fil.parents.length === 0) break;
                const best = fil.parents.reduce((a, b) => b.pct > a.pct ? b : a);
                uid = best.uid;
            }
            return cultures;
        }

        async function renderSpatialHeatmap(parcelId, feature, record, parcelRegion) {
            const container = document.getElementById('spatial-heatmap-container');
            if (spatialHeatmapMap) { spatialHeatmapMap.remove(); spatialHeatmapMap = null; }

            if (!record || !record.lineage) {
                document.getElementById('heatmap-score-value').textContent = "Pas de donn√©es";
                return;
            }

            const lineage = record.lineage || {};
            // S'assurer que la r√©gion est en MAJUSCULES pour Hugging Face
            const region = (parcelRegion || document.getElementById('region-select').value).toUpperCase();
            const year = document.getElementById('year-select').value;
            const yearNum = parseInt(year);
            const compositeId = `${year}_${parcelId}`;

            // 1. Charger les parents pour identifier les zones
            const bucket = compositeId.slice(-2);
            const data = await loadBucket(bucket, region);
            if (!data || data.error) {
                document.getElementById('heatmap-score-value').textContent = "Donn√©es indisponibles";
                return;
            }
            const fil = data.filiations ? data.filiations[compositeId] : null;
            const allParents = (fil && fil.parents) ? fil.parents : [];

            const parentScores = {};
            const scoreValues = [];

            for (const parent of allParents) {
                const parentIdParcel = parent.uid.split('_').slice(1).join('_');
                const cultures = await buildParentLineage(parent.uid, region, 7);
                const scoreData = computeRotationScore(cultures);
                const color = scoreToColor(scoreData.score);
                parentScores[parentIdParcel] = { color, score: scoreData.score };
                scoreValues.push(scoreData.score);
            }

            // Fallback si pas de parents (une seule zone)
            if (Object.keys(parentScores).length === 0) {
                const selfCodes = Object.values(lineage).map(l => l.c).filter(c => c && c !== '?');
                const selfScore = computeRotationScore(selfCodes);
                const cleanId = parcelId.includes('_') ? parcelId.split('_')[1] : parcelId;
                parentScores[cleanId] = { color: scoreToColor(selfScore.score), score: selfScore.score };
                scoreValues.push(selfScore.score);
            }

            const hasMultipleZones = Object.keys(parentScores).length > 1;
            const fillYear = hasMultipleZones ? yearNum - 1 : yearNum;

            const bbox = getFeatureBboxFromGeom(feature.geometry);
            spatialHeatmapMap = new maplibregl.Map({
                container: 'spatial-heatmap-container',
                style: { version: 8, sources: {}, layers: [{ id: 'bg', type: 'background', paint: { 'background-color': '#f1f5f9' } }] },
                bounds: [[bbox[0], bbox[1]], [bbox[2], bbox[3]]],
                fitBoundsOptions: { padding: 20 },
                interactive: false, attributionControl: false
            });

            spatialHeatmapMap.on('load', () => {
                const fillSrcId = `heatmap-fill-src`;
                spatialHeatmapMap.addSource(fillSrcId, {
                    type: 'vector',
                    url: `pmtiles://https://huggingface.co/datasets/Juckles19/iparcel-public/resolve/main/${region}_${fillYear}.pmtiles`
                });

                // REGLAGE ICI : On teste plusieurs noms de propri√©t√©s possibles (ID_PARCEL, id_parcel, etc.)
                const idExpression = ["coalesce", ["get", "ID_PARCEL"], ["get", "id_parcel"], ["get", "ID"], ["get", "id"]];
                const colorExpression = ["match", idExpression];

                Object.entries(parentScores).forEach(([id, data]) => {
                    colorExpression.push(id, data.color);
                });

                // Gris tr√®s clair au lieu de transparent pour le d√©bogage
                colorExpression.push("rgba(200,200,200,0.1)");

                // Dans la fonction renderSpatialHeatmap, sous spatialHeatmapMap.on('load', ...)
                spatialHeatmapMap.addLayer({
                    id: 'heatmap-layer-outline',
                    type: 'line',
                    source: fillSrcId,
                    'source-layer': 'parcelles',
                    paint: {
                        'line-color': '#000000', // Change le gris transparent en noir pur
                        'line-width': 1,          // Augmente l√©g√®rement l'√©paisseur (√©tait 0.5)
                        'line-opacity': 0.4       // Ajoute une opacit√© pour ne pas masquer les couleurs
                    }
                });

                // Contour de la parcelle s√©lectionn√©e
                spatialHeatmapMap.addSource('parcel-boundary', {
                    type: 'geojson',
                    data: { type: 'Feature', geometry: feature.geometry, properties: {} }
                });
                spatialHeatmapMap.addLayer({
                    id: 'parcel-boundary-line', type: 'line', source: 'parcel-boundary',
                    paint: { 'line-color': '#000', 'line-width': 2 }
                });

                const avgScore = Math.round(scoreValues.reduce((a, b) => a + b, 0) / scoreValues.length);
                document.getElementById('heatmap-score-value').textContent = `${avgScore}/10`;
                document.getElementById('heatmap-score-label').textContent = hasMultipleZones ? `${scoreValues.length} zones d√©tect√©es` : "Score de rotation";
            });
        }

        async function renderRotationHeatmap(parcelId, record) {
            const root = document.getElementById('heatmap-grid-root');
            if (!root) return;

            if (!record || !record.lineage) {
                root.innerHTML = '<p style="padding:15px;color:var(--text-muted);">Pas de donn√©es de rotation.</p>';
                return;
            }

            const lineage = record.lineage || {};
            const yearsList = ["2023", "2022", "2021", "2020", "2019", "2018", "2017", "2016"];

            // Main branch
            const codes = yearsList.map(y => {
                if (y === "2023") return record.c || record.c23;
                return lineage[y]?.c || null;
            }).filter(c => c && c !== '?');

            const uniqueCount = new Set(codes).size;
            const ratio = uniqueCount / (codes.length || 1);
            let healthColor = ratio > 0.7 ? "#10b981" : ratio > 0.4 ? "#f59e0b" : "#ef4444";

            const mainId = parcelId.includes('_') ? parcelId.split('_')[1] : parcelId;

            root.innerHTML = `
        <div class="heatmap-branch">
            <div class="branch-info">
                <span style="font-weight:700;">Parcelle ${mainId}</span>
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:0.65rem; color:var(--text-muted);">${uniqueCount} cultures / ${codes.length} ans</span>
                    <div class="health-dot" style="background:${healthColor};width:8px;height:8px;border-radius:50%;"></div>
                </div>
            </div>
            <div class="heatmap-row">
                ${yearsList.map(y => {
                const isNow = (y === "2023");
                const cultCode = isNow ? (record.c || record.c23) : (lineage[y]?.c || null);
                const group = isNow ? (record.g || record.g23) : (lineage[y]?.g || '');
                const color = cultCode ? getCultureColor(group) : '#e2e8f0';
                const name = cropLabels[cultCode] || cultCode || 'Inconnu';
                return '<div class="heatmap-cell" style="background:' + color + '" title="' + y + ' : ' + name + '"></div>';
            }).join('')}
            </div>
        </div>`;
        }

        window.loadParent = function (parentId) {
            if (!parentId || parentId === 'undefined') return;
            const year = parentId.split('_')[0];
            document.getElementById('year-select').value = year;
            document.getElementById('year-select').dispatchEvent(new Event('change'));
            // Ici on pourrait ajouter un flyTo vers le parent si on avait ses coordonn√©es
            showToast(`Passage √† la campagne ${year}`, "üìÖ");
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ PARCEL VISUALIZATION ‚Äî MINI-MAP ENGINE ‚îÄ‚îÄ
        // Creates a secondary MapLibre map in the sidebar showing
        // the 2023 parcel outline (black) overlaid on the year layer
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let miniMap = null;
        let miniMapReady = false;
        let parcelVizState = {
            parcelId: null,
            feature: null,
            yearIndex: 0,
            years: [],
            yearData: {},
            animTimer: null,
            currentVisibleYear: null,
        };

        function destroyMiniMap() {
            if (parcelVizState.animTimer) {
                clearInterval(parcelVizState.animTimer);
                parcelVizState.animTimer = null;
            }
            if (miniMap) {
                miniMap.remove();
                miniMap = null;
                miniMapReady = false;
            }
        }

        function initParcelViz(parcelId, feature, props, record, parcelRegion) {
            destroyMiniMap();

            const lineage = record ? (record.lineage || {}) : {};
            const currentYear = parseInt(document.getElementById('year-select').value);

            const allYears = [...new Set([...Object.keys(lineage).map(Number), currentYear])].sort();
            const yearData = {};

            for (const y of allYears) {
                if (y === currentYear) {
                    yearData[y] = { culture: props.CODE_CULTU, group: props.CODE_GROUP, isCurrent: true };
                } else {
                    const entry = lineage[y];
                    if (entry) {
                        yearData[y] = {
                            culture: entry.c || '?', group: entry.g || '',
                            confidence: entry.cf, parentId: entry.p, isCurrent: false
                        };
                    }
                }
            }

            parcelVizState = { parcelId, feature, yearIndex: allYears.length - 1, years: allYears, yearData };

            const slider = document.getElementById('parcel-viz-slider');
            slider.max = allYears.length - 1;
            slider.value = allYears.length - 1;
            slider.oninput = function () {
                parcelVizState.yearIndex = parseInt(this.value);
                switchMiniMapYear();
            };
            document.getElementById('parcel-viz-year-labels').innerHTML = allYears.map(y => `<span>${y}</span>`).join('');

            const bbox = getFeatureBboxFromGeom(feature.geometry);
            miniMap = new maplibregl.Map({
                container: document.getElementById('parcel-viz-svg'),
                style: { version: 8, sources: {}, layers: [{ id: 'bg', type: 'background', paint: { 'background-color': '#ffffff' } }] },
                bounds: [[bbox[0], bbox[1]], [bbox[2], bbox[3]]],
                fitBoundsOptions: { padding: 10 }, interactive: false, attributionControl: false
            });

            miniMap.on('load', () => {
                miniMapReady = true;
                const region = parcelRegion || document.getElementById('region-select').value;
                allYears.forEach(y => {
                    miniMap.addSource(`mini-src-${y}`, {
                        type: 'vector',
                        url: `pmtiles://https://huggingface.co/datasets/Juckles19/iparcel-public/resolve/main/${region}_${y}.pmtiles`
                    });
                    miniMap.addLayer({
                        id: `mini-fill-${y}`, type: 'fill', source: `mini-src-${y}`, 'source-layer': 'parcelles',
                        paint: { 'fill-color': getMapColorExpression(), 'fill-opacity': 0 }
                    });
                });

                // Outline de la parcelle actuelle
                miniMap.addSource('parcel-outline', {
                    type: 'geojson', data: {
                        type: 'FeatureCollection',
                        features: [{ type: 'Feature', geometry: feature.geometry, properties: {} }]
                    }
                });
                miniMap.addLayer({
                    id: 'outline-line', type: 'line', source: 'parcel-outline',
                    paint: { 'line-color': '#000', 'line-width': 2 }
                });

                switchMiniMapYear();
            });
        }

        function switchMiniMapYear() {
            if (!miniMap || !miniMapReady) return;
            const state = parcelVizState;
            const year = state.years[state.yearIndex];
            const yd = state.yearData[year];

            document.getElementById('parcel-viz-year').textContent = year;

            // Hide previous year layers
            if (state.currentVisibleYear && state.currentVisibleYear !== year) {
                const py = state.currentVisibleYear;
                if (miniMap.getLayer(`mini-fill-${py}`)) miniMap.setPaintProperty(`mini-fill-${py}`, 'fill-opacity', 0);
                if (miniMap.getLayer(`mini-line-${py}`)) miniMap.setPaintProperty(`mini-line-${py}`, 'line-opacity', 0);
            }

            // Show selected year layers
            if (miniMap.getLayer(`mini-fill-${year}`)) miniMap.setPaintProperty(`mini-fill-${year}`, 'fill-opacity', 0.75);
            if (miniMap.getLayer(`mini-line-${year}`)) miniMap.setPaintProperty(`mini-line-${year}`, 'line-opacity', 1);

            state.currentVisibleYear = year;
            updateVizLegendInfo(year, yd);
        }

        function updateVizLegendInfo(year, yd) {
            const legendEl = document.getElementById('parcel-viz-legend');
            const infoEl = document.getElementById('parcel-viz-info');
            if (!yd) { legendEl.innerHTML = ''; infoEl.innerHTML = ''; return; }

            const cultureName = cropLabels[yd.culture] || yd.culture;
            // Use group color from cultureColors (same as main map)
            const groupColor = yd.group ? (cultureColors[yd.group] || cultureColors.default) : cultureColors.default;
            let legendHtml = `<span class="viz-legend-item">
                <span class="viz-legend-swatch" style="background:${groupColor}"></span>${cultureName}</span>`;

            let infoHtml = `<strong>${year}</strong> ¬∑ ${cultureName}`;
            const conf = yd.confidence != null ? Math.round(yd.confidence * 100) : null;
            if (conf !== null) infoHtml += ` ¬∑ Fiabilit√©: ${conf}%`;
            if (yd.parentId) {
                infoHtml += `<br>üîó Parent: <code style="font-size:0.72rem;background:var(--border-light);padding:1px 5px;border-radius:4px;">${yd.parentId}</code>`;
                if (parentIndex) {
                    const key = `${yd.parentId}_${year}`;
                    const siblings = (parentIndex[key] || []).filter(id => id !== parcelVizState.parcelId);
                    if (siblings.length > 0) {
                        infoHtml += `<br><span style="color:#d97706;font-weight:600;">‚úÇÔ∏è ${siblings.length + 1} parcelles dans ce d√©coupage</span>`;
                        for (const sibId of siblings.slice(0, 4)) {
                            const sibRec = lineageData && lineageData[sibId];
                            if (sibRec) {
                                const sibLin = sibRec.lineage || sibRec.l || {};
                                const sibEntry = sibLin[String(year)];
                                if (sibEntry) {
                                    const sc = sibEntry.c || '?';
                                    // Look up group for sibling from current year's c23 or fallback
                                    const sibGroup = sibRec.g23 || '';
                                    const sibColor = sibGroup ? (cultureColors[sibGroup] || cultureColors.default) : cultureColors.default;
                                    legendHtml += `<span class="viz-legend-item">
                                        <span class="viz-legend-swatch" style="background:${sibColor}"></span>${cropLabels[sc] || sc}</span>`;
                                }
                            }
                        }
                    }
                }
            }
            if (yd.isCurrent) infoHtml += `<br><span style="color:var(--accent);font-weight:600;">üìç Ann√©e courante</span>`;
            infoHtml += `<br><span style="font-size:0.7rem;color:var(--text-muted);">‚ñ¨ Contour noir = parcelle 2023</span>`;

            legendEl.innerHTML = legendHtml;
            infoEl.innerHTML = infoHtml;
        }

        function getFeatureBboxFromGeom(geometry) {
            if (!geometry) return null;
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            const coords = geometry.type === 'MultiPolygon' ? geometry.coordinates.flat(2) :
                geometry.type === 'Polygon' ? geometry.coordinates.flat() : [];
            for (const [x, y] of coords) {
                if (x < minX) minX = x; if (x > maxX) maxX = x;
                if (y < minY) minY = y; if (y > maxY) maxY = y;
            }
            if (!isFinite(minX)) return null;
            const dx = (maxX - minX) * 0.3;
            const dy = (maxY - minY) * 0.3;
            return [minX - dx, minY - dy, maxX + dx, maxY + dy];
        }

        function getCultureColorByCulture(code) {
            if (!code || code === '?' || code === '‚Äî') return '#94a3b8';
            let hash = 0;
            for (let i = 0; i < code.length; i++) hash = code.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 65%, 50%)`;
        }

        function parcelVizPrev() {
            if (parcelVizState.yearIndex > 0) {
                parcelVizState.yearIndex--;
                document.getElementById('parcel-viz-slider').value = parcelVizState.yearIndex;
                switchMiniMapYear();
            }
        }
        function parcelVizNext() {
            if (parcelVizState.yearIndex < parcelVizState.years.length - 1) {
                parcelVizState.yearIndex++;
                document.getElementById('parcel-viz-slider').value = parcelVizState.yearIndex;
                switchMiniMapYear();
            }
        }
        function parcelVizPlay() {
            const state = parcelVizState;
            const btn = document.getElementById('parcel-viz-play-btn');
            if (state.animTimer) {
                clearInterval(state.animTimer); state.animTimer = null;
                btn.textContent = '‚ñ∂ Animer'; return;
            }
            btn.textContent = '‚è∏ Pause';
            state.yearIndex = 0;
            document.getElementById('parcel-viz-slider').value = 0;
            switchMiniMapYear();
            state.animTimer = setInterval(() => {
                if (state.yearIndex >= state.years.length - 1) {
                    clearInterval(state.animTimer); state.animTimer = null;
                    btn.textContent = '‚ñ∂ Animer'; return;
                }
                state.yearIndex++;
                document.getElementById('parcel-viz-slider').value = state.yearIndex;
                switchMiniMapYear();
            }, 1200);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ SUPABASE ‚Äî AUTH + EXPLOITATION ‚îÄ‚îÄ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚ö†Ô∏è REMPLACER par vos cl√©s Supabase
        const SUPABASE_URL = 'https://ajunaltvnoagvuqosgov.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqdW5hbHR2bm9hZ3Z1cW9zZ292Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMTM2MTYsImV4cCI6MjA4Nzc4OTYxNn0.lUBd7iDzmajikHWCRmYrF3yTnc-QMdmJf1rUWzdqOSk';

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentExploitation = null;
        let exploitationParcelles = [];
        let selectMode = false;
        let authMode = 'login'; // 'login' or 'register'
        let dashCultureChart = null;
        let dashMap = null;

        // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
        async function initAuth() {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                currentUser = session.user;
                onAuthSuccess();
            }
            sb.auth.onAuthStateChange((_event, session) => {
                currentUser = session?.user || null;
                updateAuthUI();
            });
        }

        function showAuthModal() {
            document.getElementById('auth-overlay').classList.remove('hidden');
            document.getElementById('auth-email').focus();
            document.body.addEventListener('keydown', authModalFocusTrap);
        }
        function hideAuthModal() {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('auth-error').textContent = '';
            document.body.removeEventListener('keydown', authModalFocusTrap);
            const btnAuth = document.getElementById('btn-auth');
            if (btnAuth) btnAuth.focus();
        }
        function authModalFocusTrap(e) {
            if (e.key !== 'Tab') return;
            if (document.getElementById('auth-overlay').classList.contains('hidden')) return;
            const focusables = document.querySelectorAll('#auth-overlay input, #auth-overlay button, #auth-overlay a');
            if (focusables.length === 0) return;
            const first = focusables[0], last = focusables[focusables.length - 1];
            if (e.shiftKey) {
                if (document.activeElement === first) { e.preventDefault(); last.focus(); }
            } else {
                if (document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
        }

        function switchAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-title').textContent = authMode === 'login' ? 'Connexion' : 'Cr√©er un compte';
            document.getElementById('auth-submit').textContent = authMode === 'login' ? 'Se connecter' : 'Cr√©er un compte';
            document.getElementById('auth-toggle').innerHTML = authMode === 'login'
                ? 'Pas encore de compte ? <a onclick="switchAuthMode()">Cr√©er un compte</a>'
                : 'D√©j√† un compte ? <a onclick="switchAuthMode()">Se connecter</a>';
            document.getElementById('auth-error').textContent = '';
        }

        async function submitAuth() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            const btn = document.getElementById('auth-submit');

            if (!email || !password) { errorEl.textContent = 'Remplissez tous les champs'; return; }
            if (password.length < 6) { errorEl.textContent = 'Mot de passe : 6 caract√®res minimum'; return; }

            btn.disabled = true;
            btn.textContent = 'Chargement...';
            errorEl.textContent = '';

            try {
                let result;
                if (authMode === 'login') {
                    result = await sb.auth.signInWithPassword({ email, password });
                } else {
                    result = await sb.auth.signUp({ email, password });
                }

                if (result.error) throw result.error;

                if (authMode === 'register' && result.data.user && !result.data.session) {
                    errorEl.textContent = '';
                    errorEl.style.color = '#10b981';
                    errorEl.textContent = '‚úì V√©rifiez votre email pour confirmer votre compte';
                    btn.disabled = false;
                    btn.textContent = 'Se connecter';
                    authMode = 'login';
                    return;
                }

                currentUser = result.data.user;
                onAuthSuccess();
            } catch (err) {
                const msg = err.message || 'Erreur inconnue';
                errorEl.style.color = '#ef4444';
                errorEl.textContent = msg.includes('Invalid login') ? 'Email ou mot de passe incorrect'
                    : msg.includes('already registered') ? 'Cet email est d√©j√† utilis√©'
                        : msg;
            }
            btn.disabled = false;
            btn.textContent = authMode === 'login' ? 'Se connecter' : 'Cr√©er un compte';
        }

        async function onAuthSuccess() {
            hideAuthModal();
            updateAuthUI();
            await loadOrCreateExploitation();
            await loadExploitationParcelles();
            renderExploitationOnMap();
            updateDashboard();
        }

        async function logout() {
            await sb.auth.signOut();
            currentUser = null;
            currentExploitation = null;
            exploitationParcelles = [];
            updateAuthUI();
            clearExploitationFromMap();
            if (document.getElementById('dashboard-panel').classList.contains('open')) {
                toggleDashboard();
            }
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('btn-auth');
            const authLabel = document.getElementById('auth-label');
            const dashBtn = document.getElementById('btn-dashboard');
            const selectBtn = document.getElementById('btn-select-mode');
            if (currentUser) {
                const name = (currentUser.email || '').split('@')[0];
                authLabel.textContent = name;
                authBtn.onclick = logout;
                authBtn.title = 'Cliquez pour vous d√©connecter';
                authBtn.classList.add('active');
                dashBtn.style.display = '';
                selectBtn.style.display = '';
            } else {
                authLabel.textContent = 'Connexion';
                authBtn.onclick = showAuthModal;
                authBtn.title = 'Se connecter';
                authBtn.classList.remove('active');
                dashBtn.style.display = 'none';
                selectBtn.style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ Exploitation CRUD ‚îÄ‚îÄ
        async function loadOrCreateExploitation() {
            if (!currentUser) return;
            console.log('[Exploitation] Loading for user:', currentUser.id);

            let { data, error } = await sb
                .from('exploitations')
                .select('*')
                .eq('user_id', currentUser.id)
                .maybeSingle();

            if (error) console.error('[Exploitation] Load error:', error);

            if (!data) {
                console.log('[Exploitation] Creating new...');
                const res = await sb.from('exploitations').insert({
                    user_id: currentUser.id,
                    name: 'Mon exploitation'
                }).select().single();
                if (res.error) {
                    console.error('[Exploitation] Create error:', res.error);
                    return;
                }
                data = res.data;
            }
            currentExploitation = data;
            console.log('[Exploitation] Ready:', currentExploitation.id);
        }

        async function renameExploitation(name) {
            if (!currentExploitation) return;
            await sb.from('exploitations')
                .update({ name })
                .eq('id', currentExploitation.id);
            currentExploitation.name = name;
        }

        async function loadExploitationParcelles() {
            if (!currentExploitation) return;
            const { data } = await sb
                .from('exploitation_parcelles')
                .select('*')
                .eq('exploitation_id', currentExploitation.id)
                .order('added_at', { ascending: false });
            exploitationParcelles = data || [];
        }

        async function addParcelToExploitation(parcelId, props, lngLat) {
            console.log('[Exploitation] addParcel called', { parcelId, hasExpl: !!currentExploitation, count: exploitationParcelles.length });

            if (!currentExploitation) {
                console.warn('[Exploitation] Pas d\'exploitation charg√©e, tentative de cr√©ation...');
                await loadOrCreateExploitation();
                if (!currentExploitation) {
                    showToast('Erreur: impossible de cr√©er l\'exploitation', '‚ùå');
                    return false;
                }
            }
            if (exploitationParcelles.length >= 200) {
                showToast('Limite de 200 parcelles atteinte', '‚ö†Ô∏è');
                return false;
            }
            if (exploitationParcelles.some(p => p.parcel_id === parcelId)) {
                showToast('Parcelle d√©j√† ajout√©e ‚úì', '‚ÑπÔ∏è');
                return false;
            }

            try {
                const insertData = {
                    exploitation_id: currentExploitation.id,
                    parcel_id: parcelId,
                    code_cultu: props.CODE_CULTU || null,
                    code_group: props.CODE_GROUP || null,
                    surf_parc: props.SURF_PARC ? parseFloat(props.SURF_PARC) : null,
                    centroid_lon: lngLat?.lng || null,
                    centroid_lat: lngLat?.lat || null,
                };
                console.log('[Exploitation] Insert:', insertData);

                const { data, error } = await sb.from('exploitation_parcelles')
                    .insert(insertData)
                    .select()
                    .single();

                if (error) {
                    console.error('[Exploitation] Supabase error:', error);
                    showToast(`Erreur: ${error.message}`, '‚ùå');
                    return false;
                }

                console.log('[Exploitation] Parcelle ajout√©e:', data);
                exploitationParcelles.push(data);
                renderExploitationOnMap();
                updateSelectCount();
                // Update dashboard only if it's open
                if (document.getElementById('dashboard-panel').classList.contains('open')) {
                    updateDashboard();
                }
                showToast(`${cropLabels[props.CODE_CULTU] || props.CODE_CULTU || parcelId} ajout√©e ‚úì`, 'üè†');
                return true;
            } catch (err) {
                console.error('[Exploitation] Exception:', err);
                showToast('Erreur r√©seau', '‚ùå');
                return false;
            }
        }

        async function removeParcelFromExploitation(parcelId) {
            if (!currentExploitation) return;
            await sb.from('exploitation_parcelles')
                .delete()
                .eq('exploitation_id', currentExploitation.id)
                .eq('parcel_id', parcelId);
            exploitationParcelles = exploitationParcelles.filter(p => p.parcel_id !== parcelId);
            renderExploitationOnMap();
            updateDashboard();
            updateSelectCount();
        }

        async function updateParcelName(parcelId, name) {
            if (!currentExploitation) return;
            const p = exploitationParcelles.find(x => x.parcel_id === parcelId);
            if (!p) return;
            const prevNotes = (p.notes || '').trim();
            if (prevNotes === (name || '').trim()) return;
            p.notes = name || null;
            const { error } = await sb.from('exploitation_parcelles')
                .update({ notes: name || null })
                .eq('exploitation_id', currentExploitation.id)
                .eq('parcel_id', parcelId);
            if (error) {
                p.notes = prevNotes || null;
                showToast('Erreur lors de l\'enregistrement du nom', '‚ùå');
                return;
            }
            const listItem = document.querySelector(`.parcel-list-item[data-parcel-id="${parcelId}"] .pli-name`);
            if (listItem) {
                const cultureName = cropLabels[p.code_cultu] || p.code_cultu || '?';
                listItem.textContent = (name && name.trim()) ? name.trim() : cultureName;
            }
            showToast('Nom enregistr√©', '‚úÖ');
        }

        // ‚îÄ‚îÄ Select Mode ‚îÄ‚îÄ
        function toggleSelectMode() {
            if (!currentUser) { showAuthModal(); return; }
            selectMode = !selectMode;
            document.getElementById('select-banner').classList.toggle('hidden', !selectMode);
            document.getElementById('btn-select-mode').classList.toggle('active', selectMode);
            map.getCanvas().style.cursor = selectMode ? 'crosshair' : '';
            updateSelectCount();
        }

        function finishSelectMode() {
            selectMode = false;
            document.getElementById('select-banner').classList.add('hidden');
            document.getElementById('btn-select-mode').classList.remove('active');
            map.getCanvas().style.cursor = '';
            // Ouvrir le dashboard pour voir les r√©sultats
            const panel = document.getElementById('dashboard-panel');
            if (!panel.classList.contains('open')) {
                toggleSidebar(false);
                panel.classList.add('open');
            }
            updateDashboard();
        }

        function updateSelectCount() {
            document.getElementById('select-count').textContent = `${exploitationParcelles.length} / 200`;
        }

        // ‚îÄ‚îÄ Map Rendering ‚îÄ‚îÄ
        function renderExploitationOnMap() {
            if (!mapReady) return;
            const srcId = 'exploitation-parcelles-src';
            const lyrFill = 'exploitation-parcelles-fill';
            const lyrLine = 'exploitation-parcelles-line';

            // Remove old layers
            if (map.getLayer(lyrFill)) map.removeLayer(lyrFill);
            if (map.getLayer(lyrLine)) map.removeLayer(lyrLine);
            if (map.getSource(srcId)) map.removeSource(srcId);

            if (exploitationParcelles.length === 0) return;

            // Build GeoJSON from centroids (points for now)
            const features = exploitationParcelles
                .filter(p => p.centroid_lon && p.centroid_lat)
                .map(p => ({
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [p.centroid_lon, p.centroid_lat] },
                    properties: { parcel_id: p.parcel_id, code_cultu: p.code_cultu }
                }));

            map.addSource(srcId, {
                type: 'geojson',
                data: { type: 'FeatureCollection', features }
            });

            map.addLayer({
                id: lyrFill, type: 'circle', source: srcId,
                paint: {
                    'circle-radius': 8,
                    'circle-color': '#1e40af',
                    'circle-opacity': 0.7,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 2,
                }
            });
        }

        function clearExploitationFromMap() {
            if (!mapReady) return;
            if (map.getLayer('exploitation-parcelles-fill')) map.removeLayer('exploitation-parcelles-fill');
            if (map.getLayer('exploitation-parcelles-line')) map.removeLayer('exploitation-parcelles-line');
            if (map.getSource('exploitation-parcelles-src')) map.removeSource('exploitation-parcelles-src');
        }

        function initOrUpdateDashMap(parcelles) {
            const container = document.getElementById('dash-exploitation-map');
            if (!container || parcelles.length === 0) return;

            // On r√©cup√®re la r√©gion R√âELLE de la premi√®re parcelle de l'exploitation
            // au lieu d'utiliser le s√©lecteur global qui a chang√©
            const exploitationRegion = parcelles[0].region || document.getElementById('region-select').value;
            const year = document.getElementById('year-select').value;
            // On utilise une r√©gion par d√©faut si "ALL" est s√©lectionn√© pour le fond

            if (!dashMap) {
                dashMap = new maplibregl.Map({
                    container: 'dash-exploitation-map',
                    style: {
                        version: 8,
                        sources: {
                            // Index 1 est g√©n√©ralement le fond "Routes/Rues" dans ton tableau basemaps
                            "osm-base": { type: "raster", tiles: [basemaps[1].tiles], tileSize: 256 }
                        },
                        layers: [{ id: "osm-layer", type: "raster", source: "osm-base" }]
                    },
                    zoom: 12,
                    attributionControl: false
                });

                const sourceId = 'src-dash-vector';
                const pmtilesUrl = `https://huggingface.co/datasets/Juckles19/iparcel-public/resolve/main/${exploitationRegion}_${year}.pmtiles`;

                if (!dashMap.getSource(sourceId)) {
                    dashMap.addSource(sourceId, {
                        type: "vector",
                        url: `pmtiles://${pmtilesUrl}`
                    });

                    dashMap.addLayer({
                        id: 'lyr-dash-fill', type: 'fill', source: 'src-dash-vector', "source-layer": "parcelles",
                        paint: {
                            'fill-color': '#10b981',
                            'fill-opacity': 0.5
                        },
                        // Filtre pour ne montrer que les parcelles de l'exploitation
                        filter: ['in', ['coalesce', ['get', 'ID_PARCEL'], ['get', 'id_parcel'], ['get', 'ID']], ['literal', parcelIds]]
                    });

                    dashMap.addLayer({
                        id: 'lyr-dash-outline', type: 'line', source: 'src-dash-vector', "source-layer": "parcelles",
                        paint: { 'line-color': '#065f46', 'line-width': 2 },
                        filter: ['in', ['coalesce', ['get', 'ID_PARCEL'], ['get', 'id_parcel'], ['get', 'ID']], ['literal', parcelIds]]
                    });

                    fitDashMapBounds(parcelles);
                };
            } else {
                // Mise √† jour du filtre si la map existe d√©j√†
                const parcelIds = parcelles.map(p => p.parcel_id);
                if (dashMap.getLayer('lyr-dash-fill')) {
                    dashMap.setFilter('lyr-dash-fill', ['in', ['coalesce', ['get', 'ID_PARCEL'], ['get', 'id_parcel'], ['get', 'ID']], ['literal', parcelIds]]);
                    dashMap.setFilter('lyr-dash-outline', ['in', ['coalesce', ['get', 'ID_PARCEL'], ['get', 'id_parcel'], ['get', 'ID']], ['literal', parcelIds]]);
                    dashMap.getSource(sourceId).setUrl(`pmtiles://${pmtilesUrl}`);
                }
                fitDashMapBounds(parcelles);
            }
        }

        function fitDashMapBounds(parcelles) {
            if (!dashMap || parcelles.length === 0) return;
            const withCoords = parcelles.filter(p => p.centroid_lon != null && p.centroid_lat != null);
            if (withCoords.length === 0) return;
            if (withCoords.length === 1) {
                dashMap.flyTo({ center: [withCoords[0].centroid_lon, withCoords[0].centroid_lat], zoom: 14, duration: 0 });
            } else {
                const lngs = withCoords.map(p => p.centroid_lon);
                const lats = withCoords.map(p => p.centroid_lat);
                const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);
                const minLat = Math.min(...lats), maxLat = Math.max(...lats);
                const padding = 0.002;
                dashMap.fitBounds([[minLng - padding, minLat - padding], [maxLng + padding, maxLat + padding]], { padding: 24, maxZoom: 14, duration: 0 });
            }
        }

        // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
        function toggleDashboard() {
            if (!currentUser) { showAuthModal(); return; }
            const panel = document.getElementById('dashboard-panel');
            const opening = !panel.classList.contains('open');
            // Fermer le side-panel si on ouvre le dashboard
            if (opening) toggleSidebar(false);
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) updateDashboard();
        }

        async function updateDashboard() {
            if (!currentExploitation) return;

            // 1. Barre Utilisateur
            document.getElementById('dash-user-bar').innerHTML = currentUser ? `
        <div class="user-bar">
            <span>üë§</span>
            <span class="user-email">${currentUser.email}</span>
            <button class="top-btn" onclick="logout()" style="font-size:0.68rem;">D√©connexion</button>
        </div>` : '';

            // 2. Nom de l'exploitation
            document.getElementById('exploitation-name').value = currentExploitation.name || '';

            const parcelles = exploitationParcelles;
            const listEl = document.getElementById('dash-parcel-list');

            if (parcelles.length === 0) {
                listEl.innerHTML = `
            <div style="text-align:center;padding:30px 20px;">
                <div style="font-size:2.5rem;margin-bottom:8px;opacity:0.3;">üè†</div>
                <p style="color:var(--text-muted);font-size:0.82rem;margin:0 0 12px;">Votre exploitation est vide</p>
                <button class="auth-btn" onclick="toggleSelectMode()" style="width:auto;padding:8px 20px;font-size:0.8rem;border-radius:8px;">
                    + Ajouter des parcelles
                </button>
            </div>`;
                updateStats(0, 0, 0, 0, '‚Äî', '‚Äî'); // Reset stats
                return;
            }

            // --- CORRECTION R√âGION : Chargement des donn√©es historiques ---
            // On utilise la r√©gion de la premi√®re parcelle de l'exploitation
            const exploitationRegion = parcelles[0].region || document.getElementById('region-select').value;

            // On charge les buckets JSON pour permettre le calcul des stats (rotation/ann√©es)
            for (const p of parcelles.slice(0, 15)) {
                const bid = getBucketId(p.parcel_id);
                const cacheKey = `${exploitationRegion}_${bid}`;
                if (!bucketCache[cacheKey]) {
                    try { await loadBucket(bid, exploitationRegion); } catch (e) { console.warn(e); }
                }
            }

            // 3. Calcul des Statistiques
            const totalSurface = parcelles.reduce((s, p) => s + (p.surf_parc || 0), 0);
            const avgSurface = totalSurface / parcelles.length;
            const culturesIds = [...new Set(parcelles.map(p => p.code_cultu).filter(Boolean))];

            let rotationScores = [];
            let yearsCounts = [];

            parcelles.forEach(p => {
                const bid = getBucketId(p.parcel_id);
                const cacheKey = `${exploitationRegion}_${bid}`;
                const year = document.getElementById('year-select').value;
                const compositeId = `${year}_${p.parcel_id}`;

                const data = bucketCache[cacheKey];
                if (data && data.filiations && data.filiations[compositeId]) {
                    const f = data.filiations[compositeId];
                    const parents = f.parents || [];
                    yearsCounts.push(1 + parents.length);

                    // Calcul simplifi√© du score de rotation (bas√© sur la diversit√© des parents)
                    const history = [p.code_cultu, ...parents.map(pa => pa.c)].filter(Boolean);
                    if (history.length >= 2) {
                        const unique = new Set(history).size;
                        rotationScores.push(Math.round((unique / history.length) * 10));
                    }
                }
            });

            const avgRotation = rotationScores.length > 0 ? (rotationScores.reduce((a, b) => a + b, 0) / rotationScores.length).toFixed(1) : '‚Äî';
            const rotColor = avgRotation === '‚Äî' ? 'var(--text-muted)' : parseFloat(avgRotation) > 6 ? '#10b981' : parseFloat(avgRotation) > 3 ? '#f59e0b' : '#ef4444';
            const avgYears = yearsCounts.length > 0 ? (yearsCounts.reduce((a, b) => a + b, 0) / yearsCounts.length).toFixed(1) : '‚Äî';

            // Rendu des blocs stats
            document.getElementById('dash-stats').innerHTML = `
        <div class="dash-stat"><div class="ds-value">${parcelles.length}</div><div class="ds-label">Parcelles</div></div>
        <div class="dash-stat"><div class="ds-value">${totalSurface.toFixed(1)} ha</div><div class="ds-label">Surface totale</div></div>
        <div class="dash-stat"><div class="ds-value">${avgYears}</div><div class="ds-label">Ann√©es moy.</div></div>
        <div class="dash-stat"><div class="ds-value" style="color:${rotColor}">${avgRotation}<span style="font-size:0.7rem;color:var(--text-muted)">/10</span></div><div class="ds-label">Rotation</div></div>`;

            // 4. Liste des parcelles (Culture en titre + Nom personnalis√©)
            listEl.innerHTML = parcelles.map(p => {
                const color = cultureColors[p.code_group] || '#9ca3af';
                const cultureName = cropLabels[p.code_cultu] || p.code_cultu || 'Culture inconnue';
                const safeNotes = (p.notes || "").replace(/"/g, '&quot;');
                const hasCoords = p.centroid_lon && p.centroid_lat;

                return `
        <div class="parcel-list-item" 
             style="cursor:${hasCoords ? 'pointer' : 'default'};"
             onclick="handleParcelListClick('${p.parcel_id}', ${p.centroid_lon}, ${p.centroid_lat})">
            <div class="pli-color" style="background:${color}"></div>
            <div class="pli-info">
                <div class="pli-name" style="font-weight:700; color:var(--text-main); font-size:0.85rem;">
                    ${cultureName}
                </div>
                <input type="text" class="pli-name-input" 
                       value="${safeNotes}" 
                       placeholder="Donner un nom (ex: Champ du Moulin)" 
                       onclick="event.stopPropagation()" 
                       onblur="updateParcelName('${p.parcel_id}', this.value.trim())"
                       style="display:block; width:100%; border:none; background:transparent; font-size:0.75rem; color:var(--text-muted); margin-top:2px; padding:0;">
                <div class="pli-meta">ID: ${p.parcel_id} ‚Ä¢ ${p.surf_parc ? p.surf_parc.toFixed(2) + ' ha' : ''}</div>
            </div>
            <button class="pli-remove" onclick="event.stopPropagation(); removeParcelFromExploitation('${p.parcel_id}')" title="Supprimer">‚úï</button>
        </div>`;
            }).join('');

            // 5. Mise √† jour de la minimap du dashboard
            setTimeout(() => initOrUpdateDashMap(parcelles), 200);
        }

        // Fonction utilitaire pour extraire le bucket ID (si absente de votre code)
        function getBucketId(id) {
            if (!id) return "00";
            const parts = String(id).split('_');
            const lastPart = parts[parts.length - 1];
            return lastPart.slice(-2).padStart(2, '0');
        }

        // ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('btn-darkmode').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('iparcel-dark', isDark ? '1' : '0');
        }
        // Restore dark mode preference
        if (localStorage.getItem('iparcel-dark') === '1') {
            document.body.classList.add('dark-mode');
            document.getElementById('btn-darkmode').textContent = '‚òÄÔ∏è';
        }

        // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'Escape') {
                if (selectMode) { toggleSelectMode(); return; }
                if (document.getElementById('dashboard-panel').classList.contains('open')) { toggleDashboard(); return; }
                if (document.getElementById('side-panel').classList.contains('open')) { toggleSidebar(false); return; }
                if (document.getElementById('auth-overlay').classList.contains('hidden') === false) { hideAuthModal(); return; }
            }
            if (e.key === 'd' && !e.ctrlKey && !e.metaKey) toggleDarkMode();
            if (e.key === 'p' && !e.ctrlKey && !e.metaKey) toggleLeftPanel();
            if (e.key === 'e' && !e.ctrlKey && !e.metaKey && currentUser) toggleSelectMode();
        });

        // ‚îÄ‚îÄ Fly to exploitation ‚îÄ‚îÄ
        function flyToExploitation() {
            if (!exploitationParcelles.length) return;
            const lons = exploitationParcelles.filter(p => p.centroid_lon).map(p => p.centroid_lon);
            const lats = exploitationParcelles.filter(p => p.centroid_lat).map(p => p.centroid_lat);
            if (!lons.length) return;
            const bounds = [
                [Math.min(...lons) - 0.01, Math.min(...lats) - 0.01],
                [Math.max(...lons) + 0.01, Math.max(...lats) + 0.01]
            ];
            map.fitBounds(bounds, { padding: 60, duration: 1500 });
        }

        // Init auth on page load
        initAuth();
        updateAuthUI();
        function closeDevPopup() {
            const popup = document.getElementById('dev-popup');
            const popupSelect = document.getElementById('popup-region-select');
            const mainSelect = document.getElementById('region-select');

            if (popupSelect && mainSelect) {
                mainSelect.value = popupSelect.value;
                mainSelect.dispatchEvent(new Event('change'));
            }
            popup.classList.add('hidden');
            setTimeout(() => popup.remove(), 400);
        }
        async function renderGenealogyTree(parcelId, parcelRegion) {
            const container = document.getElementById('genealogy-tree-container');
            const record = lineageData[parcelId];
            const year = document.getElementById('year-select').value;
            const yearNum = parseInt(year);

            if (!record || !record.lineage) {
                container.innerHTML = `<p style="color:var(--text-muted);font-size:0.8rem;">Pas de donn√©es de filiation.</p>`;
                return;
            }

            const lineage = record.lineage || {};
            const siblings = record.sib || {};
            const sortedYears = Object.keys(lineage).sort((a, b) => a - b);

            // ‚îÄ‚îÄ Charger les donn√©es de filiation pour d√©tecter les enfants (refusions) ‚îÄ‚îÄ
            const compositeId = `${year}_${parcelId}`;
            const bucket = compositeId.slice(-2);
            const data = await loadBucket(bucket, parcelRegion);
            if (!data || data.error) return;
            const fil = data.filiations ? data.filiations[compositeId] : null;
            const children = (fil && fil.children) ? fil.children : [];

            // Charger info sur les enfants pour savoir s'il y a eu refusion
            const childrenInfo = [];
            for (const child of children) {
                const childIdParcel = child.uid.split('_').slice(1).join('_');
                const childBucket = child.uid.slice(-2);
                const childData = await loadBucket(childBucket, parcelRegion);
                if (childData && childData.error) continue;
                const childParcelle = childData && childData.parcelles ? childData.parcelles[child.uid] : null;
                const childFil = childData && childData.filiations ? childData.filiations[child.uid] : null;
                const childParentCount = (childFil && childFil.parents) ? childFil.parents.length : 0;
                childrenInfo.push({
                    uid: child.uid,
                    id: childIdParcel,
                    pct: child.pct,
                    c: childParcelle ? childParcelle.c : '?',
                    g: childParcelle ? childParcelle.g : '',
                    isMerge: childParentCount > 1,
                    parentCount: childParentCount,
                });
            }

            // ‚îÄ‚îÄ Construire le HTML de l'arbre ‚îÄ‚îÄ
            function nodeHtml(id, cultCode, group, opts = {}) {
                const crop = cropLabels[cultCode] || cultCode || '?';
                const color = cultureColors[group] || '#94a3b8';
                const cls = [
                    'gtree-node',
                    opts.isCurrent ? 'is-current' : '',
                    opts.isMain ? 'is-main' : '',
                    opts.isSibling ? 'is-sibling' : '',
                ].filter(Boolean).join(' ');
                const clickAttr = opts.isCurrent ? '' : `onclick="loadParent('${opts.compositeUid || id}')"`;
                return `
                    <div class="${cls}" ${clickAttr} title="${crop} ‚Äî ${id}">
                        <div class="gtree-accent" style="background:${color};"></div>
                        <div class="gtree-body">
                            <div class="gtree-crop">${crop}</div>
                            <div class="gtree-id">${id}</div>
                            ${opts.pct !== undefined ? `<div class="gtree-pct">${Math.round(opts.pct * 100)}% recouvrement</div>` : ''}
                            ${opts.badge ? `<div class="gtree-badge" style="background:${opts.badgeColor || '#e2e8f0'};color:${opts.badgeText || '#475569'};">${opts.badge}</div>` : ''}
                        </div>
                    </div>`;
            }

            let html = '';

            // ‚îÄ‚îÄ Rang√©es des parents (du plus ancien au plus r√©cent) ‚îÄ‚îÄ
            for (let i = 0; i < sortedYears.length; i++) {
                const yr = sortedYears[i];
                const entry = lineage[yr];
                const sibs = siblings[yr] || [];

                // Connecteur entre rang√©es
                if (i > 0) {
                    const prevSibs = siblings[sortedYears[i - 1]] || [];
                    const prevCount = 1 + prevSibs.length;
                    if (prevCount > 1) {
                        html += `<div class="gtree-connectors"><div class="gtree-link-tag">fusion</div></div>`;
                    } else {
                        html += `<div class="gtree-connectors"></div>`;
                    }
                }

                html += `<div class="gtree-row">`;
                html += `<div class="gtree-year"><span class="gtree-year-label">${yr}</span></div>`;
                html += `<div class="gtree-nodes">`;

                // Noeud principal (parent direct)
                html += nodeHtml(entry.p, entry.c, entry.g, {
                    isMain: true,
                    pct: entry.cf,
                    compositeUid: `${yr}_${entry.p}`,
                });

                // Noeuds soeurs
                for (const sib of sibs) {
                    html += nodeHtml(sib.id, sib.c, sib.g, {
                        isSibling: true,
                        pct: sib.cf,
                        compositeUid: `${parseInt(yr) + 1}_${sib.id}`,
                        badge: 'soeur',
                        badgeColor: '#f1f5f9',
                        badgeText: '#64748b',
                    });
                }

                html += `</div></div>`;
            }

            // ‚îÄ‚îÄ Connecteur vers la parcelle actuelle ‚îÄ‚îÄ
            const lastYearSibs = siblings[sortedYears[sortedYears.length - 1]] || [];
            if (lastYearSibs.length > 0) {
                html += `<div class="gtree-connectors"><div class="gtree-link-tag">fusion</div></div>`;
            } else {
                html += `<div class="gtree-connectors"></div>`;
            }

            // ‚îÄ‚îÄ Parcelle actuelle ‚îÄ‚îÄ
            html += `<div class="gtree-row">`;
            html += `<div class="gtree-year"><span class="gtree-year-label">${year}</span></div>`;
            html += `<div class="gtree-nodes">`;
            html += nodeHtml(parcelId, record.c || record.c23, record.g || record.g23, {
                isCurrent: true,
                badge: 'cible',
                badgeColor: '#d1fae5',
                badgeText: '#065f46',
            });
            html += `</div></div>`;

            // ‚îÄ‚îÄ Enfants (ann√©e suivante) ‚Äî d√©tection de refusions ‚îÄ‚îÄ
            if (childrenInfo.length > 0) {
                const nextYear = yearNum + 1;
                const hasMultiple = childrenInfo.length > 1;

                if (hasMultiple) {
                    html += `<div class="gtree-connectors"><div class="gtree-link-tag">division</div></div>`;
                } else {
                    html += `<div class="gtree-connectors"></div>`;
                }

                html += `<div class="gtree-row">`;
                html += `<div class="gtree-year"><span class="gtree-year-label">${nextYear}</span></div>`;
                html += `<div class="gtree-nodes">`;

                for (const child of childrenInfo) {
                    const badge = child.isMerge ? `fusion (${child.parentCount} origines)` : (hasMultiple ? 'fragment' : 'successeur');
                    const badgeColor = child.isMerge ? '#fef3c7' : '#f1f5f9';
                    const badgeText = child.isMerge ? '#92400e' : '#64748b';

                    html += nodeHtml(child.id, child.c, child.g, {
                        pct: child.pct,
                        compositeUid: child.uid,
                        badge,
                        badgeColor,
                        badgeText,
                    });
                }

                html += `</div></div>`;
            }

            container.innerHTML = html;
        }
        function handleParcelListClick(id, lon, lat) {
            if (!map || !lon || !lat) return;

            // Centrer la carte
            map.flyTo({ center: [lon, lat], zoom: 16, duration: 1200 });

            // Surbillance (Halo jaune)
            if (map.getLayer('lyr-highlight-exploitation')) {
                map.setFilter('lyr-highlight-exploitation', ['==', ['coalesce', ['get', 'ID_PARCEL'], ['get', 'id_parcel']], id]);
            } else {
                // Cr√©er le layer s'il n'existe pas encore
                const year = document.getElementById('year-select').value;
                const region = document.getElementById('region-select').value;

                map.addLayer({
                    id: 'lyr-highlight-exploitation',
                    type: 'line',
                    source: `src-${region}_${year}`, // Doit correspondre √† vos sources dynamiques
                    'source-layer': 'parcelles',
                    paint: {
                        'line-color': '#facc15',
                        'line-width': 4,
                        'line-blur': 1
                    },
                    filter: ['==', ['coalesce', ['get', 'ID_PARCEL'], ['get', 'id_parcel']], id]
                });
            }
        }
        function getBucketId(id) {
            if (!id) return "00";
            const parts = id.split('_');
            const num = parts[parts.length - 1];
            return num.slice(-2).padStart(2, '0');
        }
    </script>
</body>

</html>